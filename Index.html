<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: #f5f7fa;
        color: #333;
      }
      
      /* Header */
      .header {
        background: #1a73e8;
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .header h1 {
        font-size: 24px;
        font-weight: 600;
      }
      
      .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .badge {
        background: #ea4335;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 8px;
      }
      
      .user-info {
        font-size: 14px;
        opacity: 0.9;
      }
      
      /* Main Container */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }
      
      /* Action Bar */
      .action-bar {
        background: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .action-buttons {
        display: flex;
        gap: 12px;
      }
      
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn-primary {
        background: #1a73e8;
        color: white;
      }
      
      .btn-primary:hover {
        background: #1557b0;
      }
      
      .btn-secondary {
        background: white;
        color: #5f6368;
        border: 1px solid #dadce0;
      }
      
      .btn-secondary:hover {
        background: #f8f9fa;
      }

      .btn-success {
        background: #188038;
        color: white;
      }

      .btn-success:hover {
        background: #137333;
      }

      .btn-warning {
        background: #f9ab00;
        color: #202124;
      }

      .btn-warning:hover {
        background: #ea8600;
      }

      /* Filters */
      .filters {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .filter-label {
        font-size: 14px;
        color: #5f6368;
        font-weight: 500;
      }
      
      select {
        padding: 8px 32px 8px 12px;
        border: 1px solid #dadce0;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
      }
      
      /* Calendar Card */
      .calendar-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      .calendar-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e8eaed;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .calendar-title {
        font-size: 20px;
        font-weight: 600;
        color: #202124;
      }
      
      .calendar-nav {
        display: flex;
        gap: 8px;
      }
      
      .nav-btn {
        width: 36px;
        height: 36px;
        border: 1px solid #dadce0;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #5f6368;
        transition: all 0.2s;
      }
      
      .nav-btn:hover {
        background: #f8f9fa;
        border-color: #5f6368;
      }
      
      /* Calendar Grid */
      .calendar {
        width: 100%;
        border-collapse: collapse;
      }
      
      .calendar th {
        padding: 16px 8px;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #5f6368;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e8eaed;
      }
      
      .calendar td {
        padding: 0;
        height: 120px;
        vertical-align: top;
        border: 1px solid #e8eaed;
        background: white;
        position: relative;
        overflow: visible;
      }
      
      .calendar td.empty {
        background: #f8f9fa;
      }
      
      .calendar td.today {
        background: #e8f0fe;
      }
      
      .day-cell {
        height: 100%;
        padding: 8px;
        cursor: pointer;
        transition: background 0.2s;
        overflow-y: auto;
        overflow-x: visible;
      }
      
      .day-cell:hover {
        background: rgba(0,0,0,0.02);
      }
      
      .day-number {
        font-size: 14px;
        font-weight: 500;
        color: #202124;
        margin-bottom: 4px;
      }
      
      .today .day-number {
        display: inline-block;
        background: #1a73e8;
        color: white;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        border-radius: 50%;
      }
      
      /* Post Items */
      .post-item {
        padding: 4px 8px;
        margin: 2px 0;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
      }

      .post-item:hover {
        transform: translateX(2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .post-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
        pointer-events: none; /* Allow hover events to pass through to parent */
      }

      /* Post Thumbnail */
      .post-thumbnail {
        width: 18px;
        height: 18px;
        border-radius: 3px;
        object-fit: cover;
        flex-shrink: 0;
        background: #e8eaed;
        border: 1px solid #dadce0;
        pointer-events: none; /* Allow hover events to pass through to parent */
      }

      .post-thumbnail:error {
        display: none;
      }

      .carousel-badge {
        font-size: 9px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 1px 4px;
        border-radius: 2px;
        margin-left: 2px;
        flex-shrink: 0;
        pointer-events: none; /* Allow hover events to pass through to parent */
      }

      /* Image hover preview */
      .image-preview-popup {
        display: none;
        position: fixed;
        z-index: 99999;
        background: white;
        border: 3px solid #1a73e8;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        pointer-events: none;
      }

      .image-preview-popup.active {
        display: block;
      }

      .image-preview-popup img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 4px;
        display: block;
      }
      
      /* Status Colors */
      .post-item.Draft {
        background: #f1f3f4;
        color: #5f6368;
        border-left: 3px solid #9aa0a6;
      }
      
      .post-item.Draft .post-dot {
        background: #9aa0a6;
      }
      
      .post-item.Internal_Review {
        background: #fef7e0;
        color: #b06000;
        border-left: 3px solid #f9ab00;
      }
      
      .post-item.Internal_Review .post-dot {
        background: #f9ab00;
      }
      
      .post-item.Client_Review {
        background: #fce8e6;
        color: #c5221f;
        border-left: 3px solid #ea4335;
      }
      
      .post-item.Client_Review .post-dot {
        background: #ea4335;
      }
      
      .post-item.Approved {
        background: #e6f4ea;
        color: #137333;
        border-left: 3px solid #34a853;
      }
      
      .post-item.Approved .post-dot {
        background: #34a853;
      }
      
      .post-item.Scheduled {
        background: #e8f0fe;
        color: #1967d2;
        border-left: 3px solid #1a73e8;
      }
      
      .post-item.Scheduled .post-dot {
        background: #1a73e8;
      }
      
      .post-item.Published {
        background: #f3e8fd;
        color: #6b21a8;
        border-left: 3px solid #9334e9;
      }

      .post-item.Published .post-dot {
        background: #9334e9;
      }

      /* Status Badges */
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
      }

      .status-badge.Draft {
        background: #f1f3f4;
        color: #5f6368;
      }

      .status-badge.Internal_Review {
        background: #fef7e0;
        color: #b06000;
      }

      .status-badge.Client_Review {
        background: #fce8e6;
        color: #c5221f;
      }

      .status-badge.Approved {
        background: #e6f4ea;
        color: #137333;
      }

      .status-badge.Scheduled {
        background: #e8f0fe;
        color: #1967d2;
      }

      .status-badge.Published {
        background: #f3e8fd;
        color: #6b21a8;
      }

      /* Legend */
      .status-filter {
        padding: 16px 24px;
        border-top: 1px solid #e8eaed;
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
      }

      .legend-label {
        font-size: 12px;
        color: #5f6368;
        font-weight: 500;
        margin-right: 8px;
      }

      .status-filter-items {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .status-filter-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border: 1px solid #dadce0;
        border-radius: 16px;
        background: white;
        color: #5f6368;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .status-filter-btn:hover {
        background: #f1f3f4;
        border-color: #5f6368;
      }

      .status-filter-btn.active {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
        font-weight: 500;
      }

      .status-filter-btn.active .legend-dot {
        border: 1px solid white;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }
      
      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }
      
      /* Loading State */
      .loading {
        display: none;
        text-align: center;
        padding: 60px 20px;
        color: #5f6368;
      }
      
      .loading.active {
        display: block;
      }
      
      .spinner {
        border: 3px solid #e8eaed;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Skeleton Screens */
      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s ease-in-out infinite;
        border-radius: 4px;
      }

      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      .skeleton-calendar {
        max-width: 1200px;
        margin: 0 auto;
      }

      .skeleton-calendar table {
        width: 100%;
        border-collapse: collapse;
      }

      .skeleton-calendar th {
        padding: 12px;
        text-align: center;
        font-weight: 600;
        color: #5f6368;
        border-bottom: 2px solid #e8eaed;
      }

      .skeleton-calendar td {
        height: 120px;
        width: 14.28%;
        padding: 8px;
        border: 1px solid #e8eaed;
        vertical-align: top;
      }

      .skeleton-day-number {
        width: 24px;
        height: 20px;
        margin-bottom: 8px;
      }

      .skeleton-post {
        height: 16px;
        margin-bottom: 6px;
        width: 100%;
      }

      /* Skeleton - Post Detail */
      .skeleton-post-detail {
        padding: 20px;
      }

      .skeleton-post-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 24px;
      }

      .skeleton-post-title {
        height: 32px;
        width: 60%;
        margin-bottom: 8px;
      }

      .skeleton-post-meta {
        height: 16px;
        width: 40%;
        margin-bottom: 4px;
      }

      .skeleton-post-status {
        height: 28px;
        width: 100px;
      }

      .skeleton-post-section {
        margin-bottom: 24px;
      }

      .skeleton-post-section-title {
        height: 20px;
        width: 120px;
        margin-bottom: 12px;
      }

      .skeleton-post-content {
        height: 80px;
        width: 100%;
        margin-bottom: 12px;
      }

      .skeleton-platform-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }

      .skeleton-platform-tab {
        height: 36px;
        width: 80px;
      }

      .skeleton-platform-image {
        height: 200px;
        width: 100%;
        margin-bottom: 12px;
      }

      .skeleton-comment {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
      }

      .skeleton-comment-avatar {
        height: 40px;
        width: 40px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .skeleton-comment-content {
        flex: 1;
      }

      .skeleton-comment-name {
        height: 16px;
        width: 120px;
        margin-bottom: 8px;
      }

      .skeleton-comment-text {
        height: 48px;
        width: 100%;
      }

      /* Skeleton - Form Loading */
      .skeleton-form {
        padding: 20px;
      }

      .skeleton-form-group {
        margin-bottom: 20px;
      }

      .skeleton-form-label {
        height: 16px;
        width: 120px;
        margin-bottom: 8px;
      }

      .skeleton-form-input {
        height: 40px;
        width: 100%;
      }

      .skeleton-form-textarea {
        height: 120px;
        width: 100%;
      }

      .skeleton-form-select {
        height: 40px;
        width: 100%;
      }

      .skeleton-form-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }

      .skeleton-form-checkbox {
        height: 20px;
        width: 80px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .calendar td {
          height: 80px;
        }

        .action-bar {
          flex-direction: column;
          align-items: stretch;
        }

        .filters {
          flex-direction: column;
        }
      }

      /* Post Creation Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100000;
        overflow-y: auto;
        padding: 20px;
      }

      .modal-overlay.active {
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        max-width: 800px;
        width: 100%;
        margin: 40px auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .modal-header {
        padding: 24px;
        border-bottom: 1px solid #e8eaed;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        font-size: 24px;
        font-weight: 600;
        color: #202124;
        margin: 0;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        font-size: 24px;
        color: #5f6368;
        cursor: pointer;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .modal-close:hover {
        background: #f1f3f4;
      }

      .modal-body {
        padding: 24px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      .form-section {
        margin-bottom: 32px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .form-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #202124;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e8eaed;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }

      .form-row.single {
        grid-template-columns: 1fr;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #5f6368;
        margin-bottom: 6px;
      }

      .form-group label.required::after {
        content: ' *';
        color: #ea4335;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        padding: 10px 12px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #1a73e8;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-group .char-counter {
        font-size: 12px;
        color: #5f6368;
        text-align: right;
        margin-top: 4px;
      }

      .form-help {
        font-size: 12px;
        color: #5f6368;
        margin-top: 4px;
        display: block;
      }

      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-item label {
        font-size: 14px;
        color: #202124;
        cursor: pointer;
        margin: 0;
      }

      .platform-media {
        margin-top: 16px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 4px;
        display: none;
      }

      .platform-media.active {
        display: block;
      }

      .platform-media-title {
        font-size: 14px;
        font-weight: 600;
        color: #202124;
        margin-bottom: 12px;
      }

      .media-upload-area {
        border: 2px dashed #dadce0;
        border-radius: 4px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
      }

      .media-upload-area:hover {
        border-color: #1a73e8;
        background: #e8f0fe;
      }

      .media-upload-area input[type="file"] {
        display: none;
      }

      .media-preview {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .media-preview-item {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 4px;
        overflow: hidden;
        border: 1px solid #dadce0;
      }

      .media-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .media-preview-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e8eaed;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .modal-footer .btn-group {
        display: flex;
        gap: 12px;
      }

      .error-message {
        color: #ea4335;
        font-size: 14px;
        padding: 12px;
        background: #fce8e6;
        border-radius: 4px;
        margin-bottom: 16px;
        display: none;
      }

      .error-message.active {
        display: block;
      }

      .success-message {
        color: #137333;
        font-size: 14px;
        padding: 12px;
        background: #e6f4ea;
        border-radius: 4px;
        margin-bottom: 16px;
        display: none;
      }

      .success-message.active {
        display: block;
      }

      @media (max-width: 768px) {
        .modal-content {
          margin: 0;
          border-radius: 0;
          min-height: 100vh;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <h1>üìÖ Social Media Planner</h1>
      <div class="header-actions">
        <div style="position: relative; display: inline-block;">
          <button class="btn btn-secondary" onclick="toggleNotifications()" id="notificationBell" style="position: relative;">
            üîî
            <span class="badge" id="notification-count" style="display: none; position: absolute; top: -8px; right: -8px; background: #ea4335; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: bold;">0</span>
          </button>
          <div id="notificationDropdown" style="display: none; position: absolute; top: 45px; right: 0; width: 350px; max-height: 400px; overflow-y: auto; background: white; border: 1px solid #dadce0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000;">
            <div style="padding: 12px; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center;">
              <strong style="font-size: 14px;">Notifications</strong>
              <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: #1a73e8; font-size: 12px; cursor: pointer; padding: 4px 8px;">Mark all read</button>
            </div>
            <div id="notificationList" style="max-height: 340px; overflow-y: auto;">
              <div style="padding: 20px; text-align: center; color: #5f6368;">Loading...</div>
            </div>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="generateTestNotification()" title="Create a test notification to preview the notification system">
          üß™ Test Notification
        </button>
        <button class="btn btn-secondary" onclick="showApprovalDashboard()">
          üì• My Approvals<span class="badge" id="approval-count" style="display: none;">0</span>
        </button>
        <span class="user-info"><?= userName ?> (<?= userRole ?>)</span>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container">
      <!-- Action Bar -->
      <div class="action-bar">
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="openPostCreationForm()">
            ‚ûï Create Post
          </button>
          <button class="btn btn-secondary" onclick="openTemplateManager()">
            üìã Templates
          </button>
          <button class="btn btn-secondary" onclick="openAdminPanel()">
            üë• Admin
          </button>
          <button class="btn btn-secondary" onclick="alert('Strategy dashboard coming in next phase!')">
            üìä Strategy
          </button>
          <button class="btn btn-secondary" onclick="refreshCalendarData()" title="Refresh calendar data">
            üîÑ Refresh
          </button>
          <button class="btn btn-secondary" onclick="showKeyboardShortcutsHelp()" title="Keyboard shortcuts (Press ?)">
            ‚å®Ô∏è Shortcuts
          </button>
        </div>

        <div class="filters">
          <span class="filter-label">Filters:</span>
          <select id="client-filter" onchange="filterCalendar()">
            <option value="">All Clients</option>
          </select>
          <select id="status-filter" onchange="filterCalendar()">
            <option value="">All Statuses</option>
            <option value="Draft">Draft</option>
            <option value="Internal_Review">Internal Review</option>
            <option value="Client_Review">Client Review</option>
            <option value="Approved">Approved</option>
            <option value="Scheduled">Scheduled</option>
            <option value="Published">Published</option>
          </select>
        </div>
      </div>

      <!-- Calendar Card -->
      <div class="calendar-card">
        <div class="calendar-header">
          <h2 class="calendar-title" id="calendar-title">October 2025</h2>
          <div class="calendar-nav">
            <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
            <button class="nav-btn" onclick="today()">Today</button>
            <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
          </div>
        </div>
        
        <!-- Loading State -->
        <div class="loading active" id="loading">
          <div class="skeleton-calendar">
            <table>
              <thead>
                <tr>
                  <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div><div class="skeleton skeleton-post"></div></td>
                </tr>
                <tr>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                </tr>
                <tr>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                </tr>
                <tr>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div></td>
                  <td><div class="skeleton skeleton-day-number"></div><div class="skeleton skeleton-post"></div></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Calendar -->
        <div id="calendar-container" style="display: none;">
          <table class="calendar" id="calendar-table"></table>
        </div>
        
        <!-- Status Filter -->
        <div class="status-filter">
          <span class="legend-label">Filter by Status:</span>
          <div class="status-filter-items">
            <button class="status-filter-btn active" data-status="all" onclick="filterByStatus('all')">
              <span>All</span>
            </button>
            <button class="status-filter-btn" data-status="Draft" onclick="filterByStatus('Draft')">
              <div class="legend-dot" style="background: #9aa0a6;"></div>
              <span>Draft</span>
            </button>
            <button class="status-filter-btn" data-status="Internal_Review" onclick="filterByStatus('Internal_Review')">
              <div class="legend-dot" style="background: #f9ab00;"></div>
              <span>Internal Review</span>
            </button>
            <button class="status-filter-btn" data-status="Client_Review" onclick="filterByStatus('Client_Review')">
              <div class="legend-dot" style="background: #ea4335;"></div>
              <span>Client Review</span>
            </button>
            <button class="status-filter-btn" data-status="Approved" onclick="filterByStatus('Approved')">
              <div class="legend-dot" style="background: #34a853;"></div>
              <span>Approved</span>
            </button>
            <button class="status-filter-btn" data-status="Scheduled" onclick="filterByStatus('Scheduled')">
              <div class="legend-dot" style="background: #1a73e8;"></div>
              <span>Scheduled</span>
            </button>
            <button class="status-filter-btn" data-status="Published" onclick="filterByStatus('Published')">
              <div class="legend-dot" style="background: #9334e9;"></div>
              <span>Published</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image preview popup -->
    <div class="image-preview-popup" id="imagePreview">
      <img src="" alt="Image preview">
    </div>

    <!-- Post Creation Modal -->
    <div class="modal-overlay" id="postCreationModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Create New Post</h2>
          <button class="modal-close" onclick="closePostCreationForm()">&times;</button>
        </div>

        <div class="modal-body">
          <div class="error-message" id="formError"></div>
          <div class="success-message" id="formSuccess"></div>

          <!-- Template Selector -->
          <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #dadce0;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <label for="templateSelector" style="font-weight: 500; margin: 0;">üìã Start from Template (Optional)</label>
              <button type="button" class="btn btn-secondary" onclick="refreshTemplates()" style="padding: 6px 12px; font-size: 13px;">üîÑ Refresh</button>
            </div>
            <select id="templateSelector" onchange="loadTemplate()" style="width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px;">
              <option value="">-- Select a template --</option>
            </select>
            <small style="display: block; margin-top: 8px; color: #5f6368;">Templates pre-fill the form with saved post data. You can still edit all fields.</small>
          </div>

          <form id="postCreationForm">
            <!-- Basic Information Section -->
            <div class="form-section">
              <div class="form-section-title">Basic Information</div>

              <div class="form-row">
                <div class="form-group">
                  <label class="required" for="postClient">Client</label>
                  <select id="postClient" name="clientId" required onchange="loadSubsidiaries()">
                    <option value="">Select a client...</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="postSubsidiaries">Subsidiaries</label>
                  <div id="subsidiariesContainer" class="checkbox-group">
                    <span class="form-help">Select a client first</span>
                  </div>
                </div>
              </div>

              <div class="form-row single">
                <div class="form-group">
                  <label class="required" for="postTitle">Post Title</label>
                  <input type="text" id="postTitle" name="title" maxlength="100" required>
                </div>
              </div>

              <div class="form-row single">
                <div class="form-group">
                  <label class="required" for="postCopy">Post Copy</label>
                  <textarea id="postCopy" name="copy" maxlength="2000" required></textarea>
                  <div class="char-counter">
                    <span id="copyCharCount">0</span> / 2000 characters
                  </div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="required" for="scheduledDate">Scheduled Date</label>
                  <input type="date" id="scheduledDate" name="scheduledDate" required>
                </div>

                <div class="form-group">
                  <label for="scheduledTime">Scheduled Time</label>
                  <input type="time" id="scheduledTime" name="scheduledTime">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="required" for="postStatus">Status</label>
                  <select id="postStatus" name="status" required>
                    <option value="Draft">Draft</option>
                    <option value="Internal_Review">Internal Review</option>
                    <option value="Client_Review">Client Review</option>
                    <option value="Approved">Approved</option>
                    <option value="Scheduled">Scheduled</option>
                    <option value="Published">Published</option>
                  </select>
                  <small class="form-help">Current workflow stage of this post</small>
                </div>

                <div class="form-group">
                  <label for="postHashtags">Hashtags</label>
                  <input type="text" id="postHashtags" name="hashtags" placeholder="#example #socialmedia">
                  <small class="form-help">Optional - Separate with spaces</small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="contentCategory">Content Category</label>
                  <select id="contentCategory" name="categoryId" multiple size="4">
                    <!-- Categories loaded dynamically -->
                  </select>
                  <small class="form-help">Hold Ctrl/Cmd to select multiple</small>
                </div>

                <div class="form-group">
                  <label for="linkUrl">Link URL</label>
                  <input type="url" id="linkUrl" name="linkUrl" placeholder="https://...">
                </div>
              </div>

              <div class="form-row single">
                <div class="form-group">
                  <label for="postNotes">
                    Internal Notes
                    <span style="color: #ea4335; font-weight: 600; margin-left: 4px;">üîí PRIVATE</span>
                  </label>
                  <textarea id="postNotes" name="notes" rows="4" placeholder="Private notes for internal team only (client will NOT see this)..."></textarea>
                  <small style="display: block; margin-top: 4px; color: #f9ab00; font-weight: 500;">
                    ‚ö†Ô∏è When editing: Keep previous notes and add new ones below. Don't overwrite existing notes.
                  </small>
                  <small class="form-help" style="color: #ea4335; font-weight: 500;">
                    ‚ö†Ô∏è These notes are PRIVATE and will NOT be shared with clients. Use for internal planning, budget info, strategy notes, or client preferences.
                  </small>
                </div>
              </div>
            </div>

            <!-- Platforms Section -->
            <div class="form-section">
              <div class="form-section-title">Platforms & Media</div>

              <div class="form-group">
                <label class="required">Select Platform(s)</label>
                <div id="platformsContainer" class="checkbox-group">
                  <!-- Platforms will be loaded here -->
                </div>
              </div>

              <!-- Platform-specific media upload areas -->
              <div id="platformMediaContainer"></div>
            </div>

            <!-- Workflow Section -->
            <div class="form-section">
              <div class="form-section-title">Workflow Assignment</div>

              <div class="form-row">
                <div class="form-group">
                  <label class="required" for="internalApprovers">Internal Approvers</label>
                  <select id="internalApprovers" name="internalApprovers" multiple size="4" required>
                    <!-- Users will be loaded here -->
                  </select>
                  <small class="form-help">Hold Ctrl/Cmd to select multiple</small>
                </div>

                <div class="form-group">
                  <label for="clientApprovers">Client Approvers</label>
                  <div id="clientApproversContainer" class="checkbox-group">
                    <span class="form-help">Select a client first</span>
                  </div>
                  <small class="form-help">Select reviewers from authorized client contacts, or add custom emails below</small>
                  <textarea id="customClientApprovers" name="customClientApprovers" rows="2" placeholder="Additional emails: email1@client.com, email2@client.com" style="margin-top: 8px;"></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closePostCreationForm()">Cancel</button>
          <div class="btn-group">
            <button id="saveDraftBtn" class="btn btn-secondary" type="button" onclick="savePostAsDraft()">Save as Draft</button>
            <button id="submitReviewBtn" class="btn btn-primary" type="button" onclick="submitPostForReview()">Submit for Review</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal-overlay" id="postDetailModal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h2 id="postDetailTitle">Post Details</h2>
          <button class="modal-close" onclick="closePostDetail()">&times;</button>
        </div>

        <div class="modal-body" id="postDetailBody">
          <!-- Content loaded dynamically -->
          <div class="skeleton-post-detail">
            <div class="skeleton-post-header">
              <div style="flex: 1;">
                <div class="skeleton skeleton-post-title"></div>
                <div class="skeleton skeleton-post-meta"></div>
                <div class="skeleton skeleton-post-meta" style="width: 30%;"></div>
              </div>
              <div class="skeleton skeleton-post-status"></div>
            </div>

            <div class="skeleton-post-section">
              <div class="skeleton skeleton-post-section-title"></div>
              <div class="skeleton skeleton-post-content"></div>
            </div>

            <div class="skeleton-post-section">
              <div class="skeleton skeleton-post-section-title"></div>
              <div class="skeleton-platform-tabs">
                <div class="skeleton skeleton-platform-tab"></div>
                <div class="skeleton skeleton-platform-tab"></div>
                <div class="skeleton skeleton-platform-tab"></div>
              </div>
              <div class="skeleton skeleton-platform-image"></div>
            </div>

            <div class="skeleton-post-section">
              <div class="skeleton skeleton-post-section-title"></div>
              <div class="skeleton-comment">
                <div class="skeleton skeleton-comment-avatar"></div>
                <div class="skeleton-comment-content">
                  <div class="skeleton skeleton-comment-name"></div>
                  <div class="skeleton skeleton-comment-text"></div>
                </div>
              </div>
              <div class="skeleton-comment">
                <div class="skeleton skeleton-comment-avatar"></div>
                <div class="skeleton-comment-content">
                  <div class="skeleton skeleton-comment-name"></div>
                  <div class="skeleton skeleton-comment-text"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer" id="postDetailFooter">
          <!-- Buttons dynamically populated by updatePostDetailActions() -->
          <button class="btn btn-secondary" type="button" onclick="closePostDetail()">Close</button>
        </div>
      </div>
    </div>

    <!-- Template Manager Modal -->
    <div class="modal-overlay" id="templateManagerModal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h2>üìã Manage Post Templates</h2>
          <button class="modal-close" onclick="closeTemplateManager()">&times;</button>
        </div>

        <div class="modal-body" id="templateManagerBody">
          <div style="margin-bottom: 20px; color: #5f6368;">
            <p style="margin: 0;">Templates let you save post configurations for faster content creation. Save commonly used post structures, categories, platforms, and copy.</p>
          </div>

          <div id="templatesList">
            <div style="text-align: center; padding: 40px; color: #9aa0a6;">
              <p>Loading templates...</p>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeTemplateManager()">Close</button>
        </div>
      </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal-overlay" id="adminPanelModal">
      <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
          <h2>üë• Admin Panel</h2>
          <button class="modal-close" onclick="closeAdminPanel()">&times;</button>
        </div>

        <div class="modal-body">
          <!-- Tab Navigation -->
          <div style="border-bottom: 2px solid #dadce0; margin-bottom: 24px;">
            <div style="display: flex; gap: 24px;">
              <button class="admin-tab active" onclick="switchAdminTab('team')" id="tab-team">
                Team Members
              </button>
              <button class="admin-tab" onclick="switchAdminTab('clients')" id="tab-clients">
                Client Access
              </button>
            </div>
          </div>

          <!-- Team Members Tab -->
          <div id="admin-tab-team" class="admin-tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">Agency Team Members</h3>
              <button class="btn btn-primary" onclick="openAddUserForm()">+ Add Team Member</button>
            </div>

            <div id="teamMembersList">
              <div style="text-align: center; padding: 40px; color: #9aa0a6;">
                <p>Loading team members...</p>
              </div>
            </div>
          </div>

          <!-- Client Access Tab -->
          <div id="admin-tab-clients" class="admin-tab-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">Client Access Management</h3>
              <div style="display: flex; align-items: center; gap: 12px;">
                <label for="clientAccessFilter" style="color: #5f6368; font-size: 14px; white-space: nowrap;">Filter by Client:</label>
                <select id="clientAccessFilter" onchange="filterClientAccess()" style="padding: 6px 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; min-width: 200px;">
                  <option value="">All Clients</option>
                </select>
              </div>
            </div>

            <div id="clientAccessList">
              <div style="text-align: center; padding: 40px; color: #9aa0a6;">
                <p>Loading client access...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeAdminPanel()">Close</button>
        </div>
      </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h2>Add Team Member</h2>
          <button class="modal-close" onclick="closeAddUserForm()">&times;</button>
        </div>

        <div class="modal-body">
          <form id="addUserForm">
            <div class="form-group">
              <label class="required" for="newUserEmail">Email</label>
              <input type="email" id="newUserEmail" name="email" required placeholder="name@finn.com">
            </div>

            <div class="form-group">
              <label class="required" for="newUserFullName">Full Name</label>
              <input type="text" id="newUserFullName" name="fullName" required placeholder="John Smith">
            </div>

            <div class="form-group">
              <label class="required" for="newUserRole">Role</label>
              <select id="newUserRole" name="role" required>
                <option value="">Select role...</option>
                <option value="Admin">Admin - Full access to everything</option>
                <option value="Editor">Editor - Can create, edit, and approve posts</option>
                <option value="Creator">Creator - Can create and edit posts</option>
                <option value="Viewer">Viewer - Read-only access</option>
              </select>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeAddUserForm()">Cancel</button>
          <button class="btn btn-primary" type="button" id="addUserSubmitBtn" onclick="submitAddUser()">Add User</button>
        </div>
      </div>
    </div>

    <style>
      .admin-tab {
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 4px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        color: #5f6368;
        transition: all 0.2s;
      }

      .admin-tab:hover {
        color: #202124;
      }

      .admin-tab.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
      }

      .admin-tab-content {
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    </style>

    <script>
      // Server-side values (force-print with JavaScript string escaping)
      const userName = "<?!= userName.replace(/"/g, '\\"').replace(/\n/g, '\\n') ?>";
      const userRole = "<?!= userRole.replace(/"/g, '\\"').replace(/\n/g, '\\n') ?>";

      // Global state
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let allPosts = [];
      let allClients = [];
      let filteredPosts = [];
      let currentStatusFilter = 'all';
      let currentPostId = null; // Track which post is currently being viewed in detail modal
      let allTemplates = []; // Store post templates

      // Cache for calendar data
      let calendarDataCache = {
        posts: null,
        clients: null,
        timestamp: null,
        cacheDuration: 5 * 60 * 1000 // 5 minutes in milliseconds
      };

      // Initialize on load
      window.onload = function() {
        // Check if google.script.run is available (only in deployed Apps Script environment)
        if (typeof google === 'undefined' || !google.script) {
          showPreviewMessage();
          return;
        }

        loadCalendarData();
        loadApprovalCount();

        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
      };

      // Keyboard shortcuts setup
      function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
          // Don't trigger shortcuts when typing in inputs
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            return;
          }

          // Get key pressed
          const key = e.key.toLowerCase();

          switch(key) {
            case 'n':
              // N = New Post
              e.preventDefault();
              openPostCreationForm();
              break;

            case 'r':
              // R = Refresh calendar
              e.preventDefault();
              refreshCalendarData();
              break;

            case 'escape':
              // Esc = Close modals
              e.preventDefault();
              closeAllModals();
              break;

            case 'arrowleft':
              // Left arrow = Previous month
              e.preventDefault();
              navigateMonth(-1);
              break;

            case 'arrowright':
              // Right arrow = Next month
              e.preventDefault();
              navigateMonth(1);
              break;

            case '?':
              // ? = Show keyboard shortcuts help
              e.preventDefault();
              showKeyboardShortcutsHelp();
              break;
          }
        });

        console.log('Keyboard shortcuts enabled');
      }

      // Close all open modals
      function closeAllModals() {
        closePostCreationForm();
        closePostDetail();
        closeTemplateManager();
        closeAdminPanel();
      }

      // Show keyboard shortcuts help modal
      function showKeyboardShortcutsHelp() {
        const helpContent = `
          <div style="padding: 20px;">
            <h3 style="margin-top: 0; color: #1a73e8;">‚å®Ô∏è Keyboard Shortcuts</h3>
            <div style="display: grid; gap: 12px; margin-top: 20px;">
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <span><strong>N</strong></span>
                <span style="color: #5f6368;">Create New Post</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <span><strong>R</strong></span>
                <span style="color: #5f6368;">Refresh Calendar</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <span><strong>Esc</strong></span>
                <span style="color: #5f6368;">Close Modals</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <span><strong>‚Üê ‚Üí</strong></span>
                <span style="color: #5f6368;">Navigate Months</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <span><strong>?</strong></span>
                <span style="color: #5f6368;">Show This Help</span>
              </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
              <button class="btn btn-primary" onclick="closeKeyboardShortcutsHelp()">Got it!</button>
            </div>
          </div>
        `;

        // Create modal overlay
        const modal = document.createElement('div');
        modal.id = 'keyboardShortcutsModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100001; display: flex; align-items: center; justify-content: center;';

        const modalContent = document.createElement('div');
        modalContent.style.cssText = 'background: white; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.2);';
        modalContent.innerHTML = helpContent;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Close on background click
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeKeyboardShortcutsHelp();
          }
        });
      }

      // Close keyboard shortcuts help
      function closeKeyboardShortcutsHelp() {
        const modal = document.getElementById('keyboardShortcutsModal');
        if (modal) {
          modal.remove();
        }
      }

      // Show message when in preview mode
      function showPreviewMessage() {
        document.getElementById('loading').innerHTML = 
          '<div style="padding: 40px; text-align: center;">' +
          '<h2 style="color: #1a73e8; margin-bottom: 16px;">üìã Preview Mode</h2>' +
          '<p style="color: #5f6368; font-size: 16px; line-height: 1.6; max-width: 500px; margin: 0 auto 24px;">This calendar needs to be deployed as a Google Apps Script web app to work properly.</p>' +
          '<p style="color: #5f6368; font-size: 14px;">Follow the deployment guide to see your calendar with real data.</p>' +
          '</div>';
      }

      // Load calendar data with optional cache bypass
      function loadCalendarData(forceRefresh = false) {
        // Check if we have valid cached data
        const now = Date.now();
        const cacheIsValid = calendarDataCache.timestamp &&
                             (now - calendarDataCache.timestamp) < calendarDataCache.cacheDuration;

        if (!forceRefresh && cacheIsValid && calendarDataCache.posts && calendarDataCache.clients) {
          console.log('Using cached calendar data');
          allPosts = calendarDataCache.posts;
          filteredPosts = allPosts;
          allClients = calendarDataCache.clients;
          populateClientFilter(allClients);
          renderCalendar();

          document.getElementById('loading').classList.remove('active');
          document.getElementById('calendar-container').style.display = 'block';
          setupImagePreview();
          loadApprovalCount();
          return;
        }

        console.log(forceRefresh ? 'Force refreshing calendar data' : 'Loading fresh calendar data');
        document.getElementById('loading').classList.add('active');
        document.getElementById('calendar-container').style.display = 'none';

        // Load posts with images
        google.script.run
          .withSuccessHandler(function(posts) {
            console.log('Loaded posts:', posts);
            console.log('Posts is array?', Array.isArray(posts));
            console.log('Posts length:', posts ? posts.length : 'null/undefined');

            // Check if error object
            if (posts && posts.success === false) {
              console.error('Error loading posts:', posts.error);
              handleError(new Error(posts.error));
              return;
            }

            allPosts = Array.isArray(posts) ? posts : [];
            filteredPosts = allPosts;
            console.log('allPosts set to:', allPosts.length, 'posts');

            // Cache the posts
            calendarDataCache.posts = allPosts;

            // Load clients
            google.script.run
              .withSuccessHandler(function(clients) {
                console.log('Loaded clients:', clients);
                allClients = Array.isArray(clients) ? clients : [];
                populateClientFilter(allClients);
                renderCalendar();

                // Update cache
                calendarDataCache.clients = allClients;
                calendarDataCache.timestamp = Date.now();

                document.getElementById('loading').classList.remove('active');
                document.getElementById('calendar-container').style.display = 'block';

                // Setup image preview after calendar is rendered
                setupImagePreview();

                // Load approval badge count
                loadApprovalCount();
              })
              .withFailureHandler(handleError)
              .getAllClients();
          })
          .withFailureHandler(handleError)
          .getAllPostsWithImages();
      }

      // Force refresh calendar data (bypass cache)
      function refreshCalendarData() {
        loadCalendarData(true);
      }

      // Invalidate cache when data changes
      function invalidateCalendarCache() {
        calendarDataCache.posts = null;
        calendarDataCache.clients = null;
        calendarDataCache.timestamp = null;
      }

      // Load approval count
      function loadApprovalCount() {
        // Check if google.script.run is available
        if (typeof google === 'undefined' || !google.script) {
          return; // Skip in preview mode
        }
        
        google.script.run
          .withSuccessHandler(function(approvals) {
            const count = Array.isArray(approvals) ? approvals.length : 0;
            const badge = document.getElementById('approval-count');
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
          })
          .withFailureHandler(function(error) {
            console.error('Error loading approval count:', error);
          })
          .getMyPendingApprovals();
      }

      // Handle errors
      function handleError(error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = 
          '<p style="color: #ea4335;">‚ö†Ô∏è Error loading calendar data</p>' +
          '<p style="font-size: 14px; margin-top: 8px;">' + error.message + '</p>' +
          '<button class="btn btn-primary" onclick="window.location.reload()" style="margin-top: 16px;">Retry</button>';
      }

      // Populate client filter
      function populateClientFilter(clients) {
        const filter = document.getElementById('client-filter');
        const currentValue = filter.value; // Save current selection

        // Clear existing options except "All Clients"
        filter.innerHTML = '<option value="">All Clients</option>';

        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.ID;
          option.textContent = client.Client_Name;
          filter.appendChild(option);
        });

        // Restore previous selection if it still exists
        if (currentValue) {
          filter.value = currentValue;
        }
      }

      // Filter calendar
      function filterCalendar() {
        const clientFilter = document.getElementById('client-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        
        filteredPosts = allPosts.filter(post => {
          const matchesClient = !clientFilter || post.Client_ID === clientFilter;
          const matchesStatus = !statusFilter || post.Status === statusFilter;
          return matchesClient && matchesStatus;
        });
        
        renderCalendar();
      }

      // Render calendar
      function renderCalendar() {
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        
        document.getElementById('calendar-title').textContent = 
          monthNames[currentMonth] + ' ' + currentYear;
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();
        const isCurrentMonth = today.getMonth() === currentMonth && 
                               today.getFullYear() === currentYear;
        
        let html = '<thead><tr>' +
                   '<th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th>' +
                   '<th>Thu</th><th>Fri</th><th>Sat</th></tr></thead><tbody>';
        
        let day = 1;
        for (let i = 0; i < 6; i++) {
          html += '<tr>';
          for (let j = 0; j < 7; j++) {
            if ((i === 0 && j < firstDay) || day > daysInMonth) {
              html += '<td class="empty"></td>';
            } else {
              const isToday = isCurrentMonth && day === today.getDate();
              const dayPosts = getPostsForDate(day);
              
              html += '<td' + (isToday ? ' class="today"' : '') + '>';
              html += '<div class="day-cell">';
              html += '<div class="day-number">' + day + '</div>';
              
              dayPosts.forEach(post => {
                const title = post.Post_Title || 'Untitled';
                const status = post.Status || 'Draft';
                const imageUrl = post.image_url || '';
                const isCarousel = post.is_carousel || false;

                html += '<div class="post-item ' + status.replace(/ /g, '_') + '" ';
                html += 'onclick="openPostDetail(\'' + post.ID + '\')" ';
                if (imageUrl) {
                  html += 'data-image-url="' + escapeHtml(imageUrl) + '" ';
                }
                html += 'title="' + escapeHtml(title) + '">';
                html += '<div class="post-dot"></div>';

                // Add thumbnail if image exists
                if (imageUrl) {
                  html += '<img src="' + escapeHtml(imageUrl) + '" class="post-thumbnail" alt="Post thumbnail">';
                }

                html += '<span>' + escapeHtml(title.substring(0, 18)) + (title.length > 18 ? '...' : '') + '</span>';

                // Add carousel badge if applicable
                if (isCarousel) {
                  html += '<span class="carousel-badge">üì∏</span>';
                }

                html += '</div>';
              });
              
              html += '</div></td>';
              day++;
            }
          }
          html += '</tr>';
          if (day > daysInMonth) break;
        }
        
        html += '</tbody>';
        document.getElementById('calendar-table').innerHTML = html;
      }

      // Get posts for specific date
      function getPostsForDate(day) {
        return filteredPosts.filter(post => {
          if (!post.Scheduled_Date) return false;
          
          // Handle different date formats
          let postDate;
          if (typeof post.Scheduled_Date === 'string') {
            // Try parsing common formats
            postDate = new Date(post.Scheduled_Date);
          } else {
            postDate = new Date(post.Scheduled_Date);
          }
          
          return postDate.getDate() === day &&
                 postDate.getMonth() === currentMonth &&
                 postDate.getFullYear() === currentYear;
        });
      }

      // Navigation functions
      function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        renderCalendar();
      }

      function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar();
      }

      function today() {
        const now = new Date();
        currentMonth = now.getMonth();
        currentYear = now.getFullYear();
        renderCalendar();
      }

      // Filter posts by status
      function filterByStatus(status) {
        console.log('Filtering by status:', status);
        currentStatusFilter = status;

        // Update active button state
        document.querySelectorAll('.status-filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector('[data-status="' + status + '"]').classList.add('active');

        // Filter posts
        if (status === 'all') {
          filteredPosts = allPosts;
        } else {
          filteredPosts = allPosts.filter(post => {
            const postStatus = (post.Status || 'Draft').replace(/ /g, '_');
            return postStatus === status;
          });
        }

        // Re-render calendar with filtered posts
        renderCalendar();
      }

      // Open post detail (placeholder)
      function openPostDetail(postId) {
        // Store current post ID for edit functionality
        currentPostId = postId;

        // Mark any notifications for this post as read (viewing = acknowledging)
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && result.count > 0) {
              // Refresh notification badge to reflect newly read notifications
              loadNotifications();
            }
          })
          .withFailureHandler(function(error) {
            console.log('Could not mark notifications read:', error);
            // Don't block opening the post if this fails
          })
          .markNotificationsReadForPost(postId);

        // Show modal with loading state
        document.getElementById('postDetailModal').classList.add('active');
        document.getElementById('postDetailBody').innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading post details...</p></div>';

        // Fetch post data
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              displayPostDetail(result.post);
            } else {
              document.getElementById('postDetailBody').innerHTML =
                '<div style="text-align: center; padding: 40px; color: #ea4335;"><p>Error: ' + (result.error || 'Failed to load post') + '</p></div>';
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('postDetailBody').innerHTML =
              '<div style="text-align: center; padding: 40px; color: #ea4335;"><p>Error: ' + error.message + '</p></div>';
          })
          .getPostById(postId);
      }

      function closePostDetail() {
        document.getElementById('postDetailModal').classList.remove('active');
        currentPostId = null;
      }

      // Edit current post being viewed
      function editCurrentPost() {
        if (!currentPostId) {
          console.error('No post ID available for editing');
          return;
        }

        // Save the post ID before closing (closePostDetail sets currentPostId to null)
        const postIdToEdit = currentPostId;
        console.log('Editing post:', postIdToEdit);

        // Close post detail modal
        closePostDetail();

        // Open edit form with this post
        editPost(postIdToEdit);
      }

      // Save current post as template
      function saveAsTemplate(postId) {
        const templateName = prompt('Enter a name for this template:\n\n(e.g., "Weekly Tip", "Product Spotlight", "Holiday Post")');

        if (!templateName) {
          return; // User cancelled
        }

        if (templateName.trim().length === 0) {
          alert('Template name cannot be empty');
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Template saved successfully!\n\nYou can now use "' + templateName + '" when creating new posts.');
              // Refresh templates list
              refreshTemplates();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to save template'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .savePostAsTemplate(postId, templateName.trim());
      }

      // Refresh templates list from backend
      function refreshTemplates() {
        google.script.run
          .withSuccessHandler(function(templates) {
            console.log('Templates loaded:', templates);
            allTemplates = Array.isArray(templates) ? templates : [];
            populateTemplateSelector();
          })
          .withFailureHandler(function(error) {
            console.error('Error loading templates:', error.message);
          })
          .getAllTemplates();
      }

      // Populate template selector dropdown
      function populateTemplateSelector() {
        const selector = document.getElementById('templateSelector');
        if (!selector) return;

        selector.innerHTML = '<option value="">-- Select a template --</option>';

        allTemplates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.ID;
          option.textContent = template.Template_Name;
          selector.appendChild(option);
        });

        console.log('Template selector populated with ' + allTemplates.length + ' templates');
      }

      // Load selected template into form
      function loadTemplate() {
        const selector = document.getElementById('templateSelector');
        const templateId = selector.value;

        if (!templateId) {
          return; // User selected "-- Select a template --"
        }

        const template = allTemplates.find(t => t.ID === templateId);
        if (!template) {
          console.error('Template not found:', templateId);
          return;
        }

        console.log('Loading template:', template);
        console.log('Template Post_Title:', template.Post_Title);
        console.log('Template Post_Copy:', template.Post_Copy);

        // Check if form elements exist - they might not be ready yet
        const postTitle = document.getElementById('postTitle');
        const postCopy = document.getElementById('postCopy');

        console.log('postTitle element:', postTitle);
        console.log('postCopy element:', postCopy);

        if (!postTitle || !postCopy) {
          console.error('Form elements not ready yet');
          // Retry after a short delay
          setTimeout(function() { loadTemplate(); }, 200);
          return;
        }

        // Populate client and trigger subsidiary/approver loading
        if (template.Client_ID) {
          const clientSelect = document.getElementById('postClient');
          clientSelect.value = template.Client_ID;
          // Trigger the change event to load subsidiaries and client approvers
          loadSubsidiaries();
        }

        // Populate basic fields
        console.log('Setting postTitle to:', template.Post_Title);
        postTitle.value = template.Post_Title || '';
        console.log('postTitle.value is now:', postTitle.value);

        console.log('Setting postCopy to:', template.Post_Copy);
        postCopy.value = template.Post_Copy || '';
        console.log('postCopy.value is now:', postCopy.value);
        document.getElementById('postHashtags').value = template.Hashtags || '';
        document.getElementById('linkUrl').value = template.Link_URL || '';
        document.getElementById('postNotes').value = template.Internal_Notes || '';

        // Update character count
        updateCharCount();

        // Wait for subsidiaries to load, then select them
        if (template.Subsidiary_IDs) {
          setTimeout(function() {
            const subsidiaryIds = template.Subsidiary_IDs.split(',').map(id => id.trim());
            const subsidiaryCheckboxes = document.querySelectorAll('input[name="subsidiaryIds"]');
            subsidiaryCheckboxes.forEach(checkbox => {
              if (subsidiaryIds.includes(checkbox.value)) {
                checkbox.checked = true;
              }
            });
          }, 600);
        }

        // Handle internal approvers
        if (template.Internal_Approvers) {
          const approverSelect = document.getElementById('internalApprovers');
          const approverEmails = template.Internal_Approvers.split(',').map(email => email.trim());

          Array.from(approverSelect.options).forEach(option => {
            if (approverEmails.includes(option.value)) {
              option.selected = true;
            }
          });
        }

        // Handle client approvers - wait for checkboxes to load
        if (template.Client_Approvers) {
          setTimeout(function() {
            const approverEmails = template.Client_Approvers.split(',').map(email => email.trim());
            const clientApproverCheckboxes = document.querySelectorAll('input[name="clientApproverCheckbox"]');
            const matchedEmails = [];

            clientApproverCheckboxes.forEach(checkbox => {
              if (approverEmails.includes(checkbox.value)) {
                checkbox.checked = true;
                matchedEmails.push(checkbox.value);
              }
            });

            // Put unmatched emails in custom field
            const unmatchedEmails = approverEmails.filter(email => !matchedEmails.includes(email));
            if (unmatchedEmails.length > 0) {
              document.getElementById('customClientApprovers').value = unmatchedEmails.join(', ');
            }
          }, 600);
        }

        // Handle platforms - parse comma-separated list
        if (template.Platforms) {
          const platforms = template.Platforms.split(',').map(p => p.trim());

          // Clear existing platform selections
          selectedPlatforms = [];
          const platformMediaContainer = document.getElementById('platformMediaContainer');
          if (platformMediaContainer) {
            platformMediaContainer.innerHTML = '';
          }

          // Select platforms from template
          const platformCheckboxes = document.querySelectorAll('#platformsContainer input[type="checkbox"]');
          platformCheckboxes.forEach(checkbox => {
            const shouldBeChecked = platforms.includes(checkbox.value);
            checkbox.checked = shouldBeChecked;

            if (shouldBeChecked) {
              togglePlatformMedia(checkbox.value);
            }
          });
        }

        // Handle content category - select in multi-select
        if (template.Content_Category && formOptions && formOptions.categories) {
          const categorySelect = document.getElementById('contentCategory');

          // Parse category name from template
          const categoryName = template.Content_Category;

          // Find matching category ID
          const category = formOptions.categories.find(c => c.Category_Name === categoryName);
          if (category) {
            // Select the option
            Array.from(categorySelect.options).forEach(option => {
              if (option.value === category.ID) {
                option.selected = true;
              }
            });
          }
        }

        // Strategy goals is not in templates yet - could be added in future version

        // Show success message
        showFormSuccess('Template "' + template.Template_Name + '" loaded! You can now edit the fields as needed.');

        // Auto-clear success message after 3 seconds
        setTimeout(function() {
          document.getElementById('formSuccess').textContent = '';
        }, 3000);
      }

      // Template Manager Functions
      function openTemplateManager() {
        const modal = document.getElementById('templateManagerModal');
        modal.classList.add('active');

        // Load templates
        loadTemplatesForManager();
      }

      function closeTemplateManager() {
        const modal = document.getElementById('templateManagerModal');
        modal.classList.remove('active');
      }

      function loadTemplatesForManager() {
        const templatesList = document.getElementById('templatesList');
        templatesList.innerHTML = '<div style="text-align: center; padding: 40px; color: #9aa0a6;"><p>Loading templates...</p></div>';

        google.script.run
          .withSuccessHandler(function(templates) {
            allTemplates = Array.isArray(templates) ? templates : [];
            displayTemplatesList(templates);
          })
          .withFailureHandler(function(error) {
            templatesList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ea4335;"><p>Error loading templates: ' + error.message + '</p></div>';
          })
          .getAllTemplates();
      }

      function displayTemplatesList(templates) {
        const templatesList = document.getElementById('templatesList');

        if (!templates || templates.length === 0) {
          templatesList.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #9aa0a6;">' +
            '<p style="font-size: 16px; margin-bottom: 12px;">No templates yet</p>' +
            '<p style="font-size: 14px;">Create a post and use "üìã Save as Template" to get started!</p>' +
            '</div>';
          return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';

        templates.forEach(function(template) {
          html += '<div style="border: 1px solid #dadce0; border-radius: 8px; padding: 16px; background: #fff;">';

          // Template header
          html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">';
          html += '<div style="flex: 1;">';
          html += '<h3 style="margin: 0 0 4px 0; font-size: 16px; color: #202124;">' + escapeHtml(template.Template_Name) + '</h3>';
          html += '<div style="font-size: 13px; color: #5f6368;">';
          html += 'Created: ' + formatDateForDisplay(template.Created_Date) + ' by ' + escapeHtml(template.Created_By);
          html += '</div>';
          html += '</div>';

          // Action buttons
          html += '<div style="display: flex; gap: 8px;">';
          html += '<button class="btn btn-secondary" onclick="useTemplate(\'' + template.ID + '\')" style="padding: 6px 12px; font-size: 13px;">‚úèÔ∏è Use</button>';
          html += '<button class="btn btn-secondary" onclick="confirmDeleteTemplate(\'' + template.ID + '\', \'' + escapeHtml(template.Template_Name).replace(/'/g, "\\'") + '\')" style="padding: 6px 12px; font-size: 13px; color: #ea4335;">üóëÔ∏è Delete</button>';
          html += '</div>';
          html += '</div>';

          // Template details
          html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">';

          if (template.Post_Title) {
            html += '<div><strong style="color: #5f6368;">Title:</strong> ' + escapeHtml(template.Post_Title) + '</div>';
          }

          if (template.Platforms) {
            html += '<div><strong style="color: #5f6368;">Platforms:</strong> ' + escapeHtml(template.Platforms) + '</div>';
          }

          if (template.Content_Category) {
            html += '<div><strong style="color: #5f6368;">Category:</strong> ' + escapeHtml(template.Content_Category) + '</div>';
          }

          if (template.Hashtags) {
            html += '<div><strong style="color: #5f6368;">Hashtags:</strong> ' + escapeHtml(template.Hashtags) + '</div>';
          }

          html += '</div>';

          // Post copy preview
          if (template.Post_Copy) {
            var copyPreview = template.Post_Copy.length > 150
              ? template.Post_Copy.substring(0, 150) + '...'
              : template.Post_Copy;
            html += '<div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">';
            html += '<strong style="color: #5f6368;">Copy:</strong><br>';
            html += '<span style="color: #202124; white-space: pre-wrap;">' + escapeHtml(copyPreview) + '</span>';
            html += '</div>';
          }

          html += '</div>';
        });

        html += '</div>';
        templatesList.innerHTML = html;
      }

      function useTemplate(templateId) {
        // Close template manager
        closeTemplateManager();

        // Open post creation form
        openPostCreationForm();

        // Select the template in the dropdown
        setTimeout(function() {
          const templateSelector = document.getElementById('templateSelector');
          if (templateSelector) {
            templateSelector.value = templateId;
            // Trigger the change event to load the template
            loadTemplate();
          }
        }, 500); // Small delay to ensure form is fully loaded
      }

      function confirmDeleteTemplate(templateId, templateName) {
        if (confirm('Are you sure you want to delete the template "' + templateName + '"?\n\nThis action cannot be undone.')) {
          deleteTemplateById(templateId);
        }
      }

      function deleteTemplateById(templateId) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Reload templates list
              loadTemplatesForManager();
              // Also refresh the template selector in the form
              refreshTemplates();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to delete template'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .deleteTemplate(templateId);
      }

      // Delete Post Functions
      function confirmDeletePost(postId, postTitle) {
        if (confirm('‚ö†Ô∏è Are you sure you want to delete "' + postTitle + '"?\n\nThis will permanently delete:\n‚Ä¢ The post\n‚Ä¢ All platform entries\n‚Ä¢ All approvals\n‚Ä¢ All comments\n‚Ä¢ All notifications\n\nThis action CANNOT be undone!')) {
          deletePostById(postId);
        }
      }

      function deletePostById(postId) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Post deleted successfully');
              // Close the detail modal
              closePostDetail();
              // Invalidate cache and reload calendar to remove the deleted post
              invalidateCalendarCache();
              loadCalendarData();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to delete post'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .deletePost(postId);
      }

      // ========================================
      // ADMIN PANEL - TEAM MANAGEMENT FUNCTIONS
      // ========================================

      /**
       * Open admin panel and load team members
       */
      function openAdminPanel() {
        const modal = document.getElementById('adminPanelModal');
        modal.classList.add('active');

        // Default to team tab
        switchAdminTab('team');
      }

      /**
       * Close admin panel
       */
      function closeAdminPanel() {
        const modal = document.getElementById('adminPanelModal');
        modal.classList.remove('active');
      }

      /**
       * Switch between admin tabs
       */
      function switchAdminTab(tabName) {
        // Update tab buttons
        const teamTabBtn = document.getElementById('tab-team');
        const clientsTabBtn = document.getElementById('tab-clients');

        if (tabName === 'team') {
          teamTabBtn.classList.add('active');
          clientsTabBtn.classList.remove('active');
          document.getElementById('admin-tab-team').style.display = 'block';
          document.getElementById('admin-tab-clients').style.display = 'none';

          // Load team members
          loadTeamMembers();
        } else {
          teamTabBtn.classList.remove('active');
          clientsTabBtn.classList.add('active');
          document.getElementById('admin-tab-team').style.display = 'none';
          document.getElementById('admin-tab-clients').style.display = 'block';

          // Load client access (to be implemented in Phase 2)
          loadClientAccess();
        }
      }

      /**
       * Load team members from backend
       */
      function loadTeamMembers() {
        const container = document.getElementById('teamMembersList');
        container.innerHTML = '<p style="text-align: center; color: #5f6368;">Loading team members...</p>';

        google.script.run
          .withSuccessHandler(function(users) {
            displayTeamMembers(users);
          })
          .withFailureHandler(function(error) {
            container.innerHTML = '<p style="color: #ea4335;">Error loading team members: ' + error.message + '</p>';
          })
          .getAllUsers();
      }

      /**
       * Display team members as cards
       */
      function displayTeamMembers(users) {
        const container = document.getElementById('teamMembersList');

        if (!users || users.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #5f6368;">No team members found. Click "Add Team Member" to get started.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 16px;">';

        users.forEach(function(user) {
          // Only show active users
          if (user.Status !== 'Active') return;

          const roleColor = {
            'Admin': '#ea4335',
            'Editor': '#fbbc04',
            'Creator': '#34a853',
            'Viewer': '#4285f4'
          }[user.Default_Role] || '#5f6368';

          html += '<div style="border: 1px solid #dadce0; border-radius: 8px; padding: 16px; background: white;">';
          html += '  <div style="display: flex; justify-content: space-between; align-items: start;">';
          html += '    <div style="flex: 1;">';
          html += '      <div style="font-weight: 500; margin-bottom: 4px;">' + escapeHtml(user.Full_Name || '') + '</div>';
          html += '      <div style="color: #5f6368; font-size: 14px; margin-bottom: 8px;">' + escapeHtml(user.Email || '') + '</div>';
          html += '      <div style="display: inline-block; padding: 4px 8px; border-radius: 4px; background: ' + roleColor + '; color: white; font-size: 12px; font-weight: 500;">';
          html += escapeHtml(user.Default_Role || 'No Role');
          html += '      </div>';
          html += '    </div>';
          html += '    <div style="display: flex; gap: 8px;">';

          // Role change dropdown
          html += '      <select onchange="changeUserRole(\'' + user.ID + '\', this.value)" style="padding: 6px 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px;">';
          html += '        <option value="">Change Role...</option>';
          html += '        <option value="Admin"' + (user.Default_Role === 'Admin' ? ' selected' : '') + '>Admin</option>';
          html += '        <option value="Editor"' + (user.Default_Role === 'Editor' ? ' selected' : '') + '>Editor</option>';
          html += '        <option value="Creator"' + (user.Default_Role === 'Creator' ? ' selected' : '') + '>Creator</option>';
          html += '        <option value="Viewer"' + (user.Default_Role === 'Viewer' ? ' selected' : '') + '>Viewer</option>';
          html += '      </select>';

          // Deactivate button
          html += '      <button onclick="deactivateUserConfirm(\'' + user.ID + '\', \'' + escapeHtml(user.Full_Name || user.Email) + '\')" ';
          html += '        style="padding: 6px 12px; background: white; color: #ea4335; border: 1px solid #ea4335; border-radius: 4px; cursor: pointer; font-size: 14px;">';
          html += '        Deactivate';
          html += '      </button>';
          html += '    </div>';
          html += '  </div>';

          // Show created info
          if (user.Created_Date) {
            const createdDate = new Date(user.Created_Date).toLocaleDateString();
            html += '  <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f3f4; font-size: 12px; color: #5f6368;">';
            html += '    Added on ' + createdDate;
            if (user.Created_By) {
              html += ' by ' + escapeHtml(user.Created_By);
            }
            html += '  </div>';
          }

          html += '</div>';
        });

        html += '</div>';

        container.innerHTML = html;
      }

      /**
       * Open add user form
       */
      function openAddUserForm() {
        const modal = document.getElementById('addUserModal');
        modal.classList.add('active');

        // Clear form
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserFullName').value = '';
        document.getElementById('newUserRole').value = 'Creator';
      }

      /**
       * Close add user form
       */
      function closeAddUserForm() {
        const modal = document.getElementById('addUserModal');
        modal.classList.remove('active');
      }

      /**
       * Submit new user form
       */
      function submitAddUser() {
        const email = document.getElementById('newUserEmail').value.trim();
        const fullName = document.getElementById('newUserFullName').value.trim();
        const role = document.getElementById('newUserRole').value;

        // Validate
        if (!email) {
          alert('Please enter an email address');
          return;
        }

        if (!fullName) {
          alert('Please enter a full name');
          return;
        }

        if (!role) {
          alert('Please select a role');
          return;
        }

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('Please enter a valid email address');
          return;
        }

        // Show loading
        const submitBtn = document.getElementById('addUserSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        // Call backend
        google.script.run
          .withSuccessHandler(function(result) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add User';

            if (result.success) {
              alert('‚úÖ User added successfully!');
              closeAddUserForm();
              loadTeamMembers(); // Reload the list
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to add user'));
            }
          })
          .withFailureHandler(function(error) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add User';
            alert('‚ùå Error: ' + error.message);
          })
          .addUser({
            email: email,
            fullName: fullName,
            role: role
          });
      }

      /**
       * Change user role
       */
      function changeUserRole(userId, newRole) {
        if (!newRole) return; // User selected "Change Role..." placeholder

        if (!confirm('Change this user\'s role to ' + newRole + '?')) {
          // Reset dropdown to current value
          loadTeamMembers();
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Role updated successfully');
              loadTeamMembers(); // Reload to show updated role
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to update role'));
              loadTeamMembers(); // Reload to reset dropdown
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
            loadTeamMembers();
          })
          .updateUser(userId, {role: newRole});
      }

      /**
       * Deactivate user with confirmation
       */
      function deactivateUserConfirm(userId, userName) {
        if (!confirm('‚ö†Ô∏è Are you sure you want to deactivate ' + userName + '?\n\nThey will no longer be able to access the system.')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ User deactivated successfully');
              loadTeamMembers(); // Reload to remove from list
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to deactivate user'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .deactivateUser(userId);
      }

      /**
       * Load client access records from backend
       */
      // Store all authorized clients for filtering
      let allAuthorizedClients = [];

      function loadClientAccess() {
        const container = document.getElementById('clientAccessList');
        container.innerHTML = '<p style="text-align: center; color: #5f6368;">Loading client access records...</p>';

        google.script.run
          .withSuccessHandler(function(authorizedClients) {
            // Store globally for filtering
            allAuthorizedClients = authorizedClients;

            // Populate filter dropdown
            populateClientFilter(authorizedClients);

            // Display all by default
            displayClientAccess(authorizedClients);
          })
          .withFailureHandler(function(error) {
            container.innerHTML = '<p style="color: #ea4335;">Error loading client access: ' + error.message + '</p>';
          })
          .getAllAuthorizedClients();
      }

      /**
       * Populate client filter dropdown with unique clients
       */
      function populateClientFilter(authorizedClients) {
        const filter = document.getElementById('clientAccessFilter');
        if (!filter) return;

        // Get unique clients
        const clientsMap = {};
        authorizedClients.forEach(function(ac) {
          if (ac.Status === 'Active' && ac.Client_ID && ac.Client_Name) {
            clientsMap[ac.Client_ID] = ac.Client_Name;
          }
        });

        // Sort clients alphabetically
        const clients = Object.keys(clientsMap).sort(function(a, b) {
          return clientsMap[a].localeCompare(clientsMap[b]);
        });

        // Populate dropdown
        let html = '<option value="">All Clients (' + authorizedClients.filter(ac => ac.Status === 'Active').length + ')</option>';
        clients.forEach(function(clientId) {
          const count = authorizedClients.filter(ac => ac.Client_ID === clientId && ac.Status === 'Active').length;
          html += '<option value="' + escapeHtml(clientId) + '">' + escapeHtml(clientsMap[clientId]) + ' (' + count + ')</option>';
        });

        filter.innerHTML = html;
      }

      /**
       * Filter client access by selected client
       */
      function filterClientAccess() {
        const filter = document.getElementById('clientAccessFilter');
        const selectedClientId = filter ? filter.value : '';

        // Filter the list
        let filteredClients = allAuthorizedClients;
        if (selectedClientId) {
          filteredClients = allAuthorizedClients.filter(function(ac) {
            return ac.Client_ID === selectedClientId;
          });
        }

        // Display filtered results
        displayClientAccess(filteredClients);
      }

      /**
       * Display client access records as cards
       */
      function displayClientAccess(authorizedClients) {
        const container = document.getElementById('clientAccessList');

        if (!authorizedClients || authorizedClients.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #5f6368;">No client access records found. Grant client access from a post to get started.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 16px;">';

        authorizedClients.forEach(function(ac) {
          // Only show active records
          if (ac.Status !== 'Active') return;

          const isAdmin = ac.Access_Level === 'Admin' && (!ac.Post_IDs || ac.Post_IDs === '');
          const accessLevelColor = {
            'Admin': '#ea4335',
            'Full': '#34a853',
            'Read_Only': '#4285f4'
          }[ac.Access_Level] || '#5f6368';

          html += '<div style="border: 1px solid #dadce0; border-radius: 8px; padding: 16px; background: white;">';
          html += '  <div style="display: flex; justify-content: space-between; align-items: start;">';
          html += '    <div style="flex: 1;">';

          // Client name and email
          html += '      <div style="font-weight: 500; margin-bottom: 4px;">';
          html += escapeHtml(ac.Client_Name || 'Unknown Client');
          if (isAdmin) {
            html += ' <span style="margin-left: 8px; padding: 2px 6px; background: #ea4335; color: white; font-size: 11px; border-radius: 3px; font-weight: 600;">CLIENT ADMIN</span>';
          }
          html += '      </div>';
          html += '      <div style="color: #5f6368; font-size: 14px; margin-bottom: 12px;">' + escapeHtml(ac.Email || '') + '</div>';

          // Two-row permission display
          html += '      <div style="display: grid; gap: 6px; margin-bottom: 4px;">';

          // Row 1: Permission Level
          html += '        <div style="display: flex; align-items: center; gap: 8px;">';
          html += '          <span style="color: #5f6368; font-size: 12px; min-width: 90px;">Permission:</span>';
          html += '          <div style="display: inline-block; padding: 4px 8px; border-radius: 4px; background: ' + accessLevelColor + '; color: white; font-size: 12px; font-weight: 500;">';
          html += escapeHtml(ac.Access_Level || 'Full');
          html += '          </div>';

          // Show what this permission means
          var permissionDesc = '';
          if (ac.Access_Level === 'Admin') {
            permissionDesc = 'Can approve/reject + manage reviewers';
          } else if (ac.Access_Level === 'Full') {
            permissionDesc = 'Can approve/reject posts';
          } else if (ac.Access_Level === 'Read_Only') {
            permissionDesc = 'View only';
          }
          html += '          <span style="color: #5f6368; font-size: 11px; font-style: italic;">' + permissionDesc + '</span>';
          html += '        </div>';

          // Row 2: Post Scope
          html += '        <div style="display: flex; align-items: center; gap: 8px;">';
          html += '          <span style="color: #5f6368; font-size: 12px; min-width: 90px;">Post Access:</span>';

          const hasAllPosts = !ac.Post_IDs || ac.Post_IDs === '';
          if (hasAllPosts) {
            html += '          <div style="display: inline-block; padding: 4px 8px; border-radius: 4px; background: #34a853; color: white; font-size: 12px; font-weight: 500;">';
            html += 'All Posts';
            html += '          </div>';
            html += '          <span style="color: #5f6368; font-size: 11px; font-style: italic;">Can see all posts for ' + escapeHtml(ac.Client_Name || 'this client') + '</span>';
          } else {
            const postCount = ac.Post_IDs.split(',').length;
            html += '          <div style="display: inline-block; padding: 4px 8px; border-radius: 4px; background: #fbbc04; color: white; font-size: 12px; font-weight: 500;">';
            html += 'Specific Posts';
            html += '          </div>';
            html += '          <span style="color: #5f6368; font-size: 11px; font-style: italic;">' + postCount + ' post' + (postCount > 1 ? 's' : '') + ' only</span>';
          }
          html += '        </div>';

          html += '      </div>';

          html += '    </div>';

          // Action buttons
          html += '    <div style="display: flex; flex-direction: column; gap: 8px; min-width: 240px;">';

          // Section label
          html += '      <div style="font-size: 11px; font-weight: 600; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px;">Actions</div>';

          // Access level dropdown (Permission only)
          html += '      <select onchange="updateClientAccessLevel(\'' + ac.ID + '\', this.value)" style="padding: 6px 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 13px;">';
          html += '        <option value="">Change Permission...</option>';
          html += '        <option value="Admin"' + (ac.Access_Level === 'Admin' ? ' selected' : '') + '>Admin (approve + manage)</option>';
          html += '        <option value="Full"' + (ac.Access_Level === 'Full' ? ' selected' : '') + '>Full (approve/reject)</option>';
          html += '        <option value="Read_Only"' + (ac.Access_Level === 'Read_Only' ? ' selected' : '') + '>Read Only (view only)</option>';
          html += '      </select>';

          // Separator
          html += '      <div style="border-top: 1px solid #f1f3f4; margin: 4px 0;"></div>';

          // Set/Remove as client admin button (changes both permission AND post scope)
          if (isAdmin) {
            html += '      <button onclick="removeClientAdmin(\'' + ac.ID + '\', \'' + escapeHtml(ac.Email) + '\')" ';
            html += '        style="padding: 6px 12px; background: white; color: #ea4335; border: 1px solid #ea4335; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">';
            html += '        ‚Üì Demote from Client Admin';
            html += '      </button>';
            html += '      <div style="font-size: 10px; color: #5f6368; margin-top: -4px; line-height: 1.3;">Will keep Full permission but lose "All Posts" access</div>';
          } else {
            html += '      <button onclick="setAsClientAdmin(\'' + ac.ID + '\', \'' + escapeHtml(ac.Email) + '\')" ';
            html += '        style="padding: 6px 12px; background: #ea4335; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">';
            html += '        ‚Üë Promote to Client Admin';
            html += '      </button>';
            html += '      <div style="font-size: 10px; color: #5f6368; margin-top: -4px; line-height: 1.3;">Will set Admin permission + grant "All Posts" access</div>';
          }

          // Separator
          html += '      <div style="border-top: 1px solid #f1f3f4; margin: 4px 0;"></div>';

          // Revoke access button
          html += '      <button onclick="revokeClientAccessConfirm(\'' + ac.ID + '\', \'' + escapeHtml(ac.Email) + '\')" ';
          html += '        style="padding: 6px 12px; background: white; color: #5f6368; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; font-size: 13px;">';
          html += '        Revoke Access';
          html += '      </button>';

          html += '    </div>';
          html += '  </div>';

          // Show access URL section
          if (ac.Access_URL) {
            html += '  <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f3f4;">';
            html += '    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">';
            html += '      <div style="flex: 1;">';
            html += '        <div style="font-size: 11px; font-weight: 600; color: #5f6368; margin-bottom: 4px;">CLIENT ACCESS URL</div>';
            html += '        <div style="font-size: 11px; color: #5f6368; font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">';
            html += escapeHtml(ac.Access_URL.substring(0, 60)) + '...';
            html += '        </div>';
            html += '      </div>';
            // Use data attribute to safely store the URL
            html += '      <button class="copy-url-btn" data-url="' + escapeHtml(ac.Access_URL) + '" ';
            html += '        style="padding: 6px 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">';
            html += '        üìã Copy URL';
            html += '      </button>';
            html += '    </div>';
            html += '  </div>';
          }

          // Show created info
          if (ac.Created_Date) {
            const createdDate = new Date(ac.Created_Date).toLocaleDateString();
            html += '  <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f1f3f4; font-size: 12px; color: #5f6368;">';
            html += '    Access granted on ' + createdDate;
            if (ac.Created_By) {
              html += ' by ' + escapeHtml(ac.Created_By);
            }
            if (ac.Last_Login) {
              const lastLogin = new Date(ac.Last_Login).toLocaleDateString();
              html += ' ‚Ä¢ Last login: ' + lastLogin;
            }
            html += '  </div>';
          }

          html += '</div>';
        });

        html += '</div>';

        container.innerHTML = html;

        // Add event delegation for copy URL buttons
        setTimeout(function() {
          const copyButtons = document.querySelectorAll('.copy-url-btn');
          copyButtons.forEach(function(button) {
            button.addEventListener('click', function() {
              const url = this.getAttribute('data-url');
              copyAccessUrl(url);
            });
          });
        }, 100);
      }

      /**
       * Update client access level
       */
      function updateClientAccessLevel(authorizedClientId, newAccessLevel) {
        if (!newAccessLevel) return; // User selected placeholder

        if (!confirm('Change access level to ' + newAccessLevel + '?')) {
          loadClientAccess(); // Reset dropdown
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Access level updated successfully');
              loadClientAccess(); // Reload list
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to update access level'));
              loadClientAccess();
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
            loadClientAccess();
          })
          .updateAuthorizedClient(authorizedClientId, {accessLevel: newAccessLevel});
      }

      /**
       * Set a client contact as admin (full access to all posts + can manage reviewers)
       */
      function setAsClientAdmin(authorizedClientId, email) {
        if (!confirm('‚ö†Ô∏è Promote ' + email + ' to Client Admin?\n\nThey will:\n‚Ä¢ Have full access to ALL posts for their client\n‚Ä¢ Be able to add and remove other reviewers\n\nThis is a powerful permission!')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Client promoted to Admin successfully!\n\nThey can now manage reviewers for their organization.');
              loadClientAccess();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to set as admin'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .setAsClientAdmin(authorizedClientId);
      }

      /**
       * Remove client admin status (downgrade to Full access with specific posts)
       */
      function removeClientAdmin(authorizedClientId, email) {
        if (!confirm('Remove Admin status from ' + email + '?\n\nThey will:\n‚Ä¢ No longer be able to manage reviewers\n‚Ä¢ Keep Full access to their assigned posts\n\nContinue?')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Admin status removed successfully');
              loadClientAccess();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to remove admin status'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .updateAuthorizedClient(authorizedClientId, {accessLevel: 'Full'});
      }

      /**
       * Copy access URL to clipboard
       */
      function copyAccessUrl(url) {
        // Create temporary textarea to copy URL
        const textarea = document.createElement('textarea');
        textarea.value = url;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
          document.execCommand('copy');
          alert('‚úÖ Access URL copied to clipboard!\n\nYou can now paste and send this URL to the client.');
        } catch (err) {
          alert('‚ùå Failed to copy URL. Please copy manually:\n\n' + url);
        }

        document.body.removeChild(textarea);
      }

      /**
       * Revoke client access with confirmation
       */
      function revokeClientAccessConfirm(authorizedClientId, email) {
        if (!confirm('‚ö†Ô∏è Revoke access for ' + email + '?\n\nThey will no longer be able to:\n‚Ä¢ View posts\n‚Ä¢ Approve or reject posts\n‚Ä¢ Access the client portal\n\nThis action can be undone by re-granting access.')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Access revoked successfully');
              loadClientAccess(); // Reload to remove from list
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to revoke access'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .updateAuthorizedClient(authorizedClientId, {status: 'Inactive'});
      }

      // ========================================
      // END ADMIN PANEL FUNCTIONS
      // ========================================

      function displayPostDetail(post) {
        console.log('Displaying post:', post);

        // Store post data globally for client access functions
        window.currentPostData = post;

        // Format status badge
        const statusClass = (post.Status || 'Draft').replace(/ /g, '_');
        const statusBadge = `<span class="status-badge ${statusClass}">${post.Status || 'Draft'}</span>`;

        // Format dates
        const scheduledDate = post.Scheduled_Date ? new Date(post.Scheduled_Date).toLocaleDateString() : 'Not scheduled';
        const scheduledTime = post.Scheduled_Time || '';
        const createdDate = post.Created_Date ? new Date(post.Created_Date).toLocaleString() : '';
        const modifiedDate = post.Modified_Date ? new Date(post.Modified_Date).toLocaleString() : '';

        // Build HTML
        let html = '<div class="post-detail-content">';

        // Header section with title and status
        html += '<div style="margin-bottom: 24px;">';
        html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">`;
        html += `<h3 style="margin: 0; flex: 1;">${escapeHtml(post.Post_Title || 'Untitled Post')}</h3>`;
        html += statusBadge;
        html += '</div>';
        html += `<p style="color: #5f6368; margin: 4px 0;">ID: ${post.ID}</p>`;
        html += '</div>';

        // Client & Subsidiaries
        html += '<div class="detail-section">';
        html += '<h4>Client Information</h4>';
        html += `<p><strong>Client:</strong> ${post.client ? escapeHtml(post.client.Client_Name) : 'N/A'}</p>`;
        if (post.subsidiaries && post.subsidiaries.length > 0) {
          html += '<p><strong>Subsidiaries:</strong> ' + post.subsidiaries.map(s => escapeHtml(s.Subsidiary_Name)).join(', ') + '</p>';
        }
        html += '</div>';

        // Post Content
        html += '<div class="detail-section">';
        html += '<h4>Post Content</h4>';
        html += `<div style="background: #f8f9fa; padding: 12px; border-radius: 4px; white-space: pre-wrap;">${escapeHtml(post.Post_Copy || '')}</div>`;
        if (post.Hashtags) {
          html += `<p style="margin-top: 8px;"><strong>Hashtags:</strong> ${escapeHtml(post.Hashtags)}</p>`;
        }
        if (post.Link_URL) {
          html += `<p><strong>Link:</strong> <a href="${escapeHtml(post.Link_URL)}" target="_blank">${escapeHtml(post.Link_URL)}</a></p>`;
        }
        html += '</div>';

        // Categories
        if (post.categories && post.categories.length > 0) {
          html += '<div class="detail-section">';
          html += '<h4>Content Categories</h4>';
          html += '<p>' + post.categories.map(c => escapeHtml(c.Category_Name)).join(', ') + '</p>';
          html += '</div>';
        }

        // Scheduling
        html += '<div class="detail-section">';
        html += '<h4>Scheduling</h4>';
        html += `<p><strong>Scheduled Date:</strong> ${scheduledDate} ${scheduledTime}</p>`;

        // Show Published Date if post is published
        if (post.Status === 'Published' && post.Published_Date) {
          const publishedDate = new Date(post.Published_Date).toLocaleString();
          html += `<p><strong>üìÖ Published Date:</strong> <span style="color: #9334e9; font-weight: 500;">${publishedDate}</span></p>`;
        }
        html += '</div>';

        // Platforms & Media
        if (post.platforms && post.platforms.length > 0) {
          html += '<div class="detail-section">';
          html += '<h4>Platforms & Media</h4>';
          html += '<div style="display: grid; gap: 12px;">';

          post.platforms.forEach(platform => {
            html += '<div style="border: 1px solid #dadce0; padding: 12px; border-radius: 4px;">';
            html += `<p style="margin: 0 0 8px 0;"><strong>Platform:</strong> ${escapeHtml(platform.Platform_Name || platform.Platform_ID)}</p>`;
            if (platform.Platform_Copy) {
              html += `<p style="margin: 0 0 8px 0;"><strong>Custom Copy:</strong> ${escapeHtml(platform.Platform_Copy)}</p>`;
            }
            if (platform.Media_Type) {
              html += `<p style="margin: 0 0 8px 0;"><strong>Media Type:</strong> ${escapeHtml(platform.Media_Type)}</p>`;
            }
            if (platform.Media_File_URL_Extracted) {
              const mediaType = (platform.Media_Type || '').toLowerCase();
              const isCarousel = mediaType.includes('carousel');

              html += `<div style="margin-top: 8px;">`;
              if (isCarousel) {
                // For carousels, show the actual link as clickable text
                html += `<div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #1a73e8;">`;
                html += `<p style="margin: 0 0 8px 0; font-size: 13px; color: #5f6368;">üì∏ Carousel (Multiple Images)</p>`;
                html += `<a href="${escapeHtml(platform.Media_File_URL_Extracted)}" target="_blank" style="color: #1a73e8; text-decoration: none; font-size: 12px; word-break: break-all;">${escapeHtml(platform.Media_File_URL_Extracted)}</a>`;
                html += `</div>`;
              } else {
                // For single images/videos, try to display
                // Convert Box /s/ URLs to /shared/static/ for embedding
                const embedUrl = platform.Media_File_URL_Extracted.includes('box.com/s/')
                  ? platform.Media_File_URL_Extracted.replace('/s/', '/shared/static/')
                  : platform.Media_File_URL_Extracted;

                html += `<img src="${escapeHtml(embedUrl)}" style="max-width: 100%; max-height: 300px; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">`;
                html += `<div style="display: none; background: #f8f9fa; padding: 12px; border-radius: 4px;">`;
                html += `<p style="margin: 0 0 8px 0; color: #5f6368; font-size: 12px;">Image preview unavailable</p>`;
                html += `<a href="${escapeHtml(platform.Media_File_URL_Extracted)}" target="_blank" style="color: #1a73e8; text-decoration: none; font-size: 13px;">View in Box ‚Üí</a>`;
                html += `</div>`;
              }
              html += '</div>';
            }
            html += '</div>';
          });

          html += '</div>';
          html += '</div>';
        }

        // Notes
        if (post.Notes) {
          html += '<div class="detail-section">';
          html += '<h4>Notes</h4>';
          html += `<p>${escapeHtml(post.Notes)}</p>`;
          html += '</div>';
        }

        // Approvers
        html += '<div class="detail-section">';
        html += '<h4>Approvals</h4>';
        if (post.Internal_Approvers) {
          html += `<p><strong>Internal Approvers:</strong> ${escapeHtml(post.Internal_Approvers)}</p>`;
        }
        if (post.Client_Approvers) {
          html += `<p><strong>Client Approvers:</strong> ${escapeHtml(post.Client_Approvers)}</p>`;
        }
        html += '</div>';

        // Client Access Section (only for Client_Review status)
        html += '<div id="clientAccessSection" style="display: none;">';
        html += '<div class="detail-section" style="background: #e8f0fe; padding: 16px; border-radius: 4px;">';
        html += '<h4 style="color: #1a73e8;">üîó Client Portal Access</h4>';

        // Token status
        html += '<div id="clientTokenStatus">';
        html += '<p style="color: #5f6368;">Loading access status...</p>';
        html += '</div>';

        // Token generator (if no token exists)
        html += '<div id="clientTokenGenerator" style="display: none; margin-top: 12px;">';
        html += '<p style="margin-bottom: 12px;">This client approver doesn\'t have portal access yet.</p>';
        html += '<button class="btn btn-primary" onclick="generateClientToken()">Generate Access Token</button>';
        html += '<div style="background: #e8f0fe; padding: 12px; margin-top: 12px; border-radius: 4px; border-left: 3px solid #1a73e8;">';
        html += '<p style="margin: 0; font-size: 13px; color: #1967d2;"><strong>üìã Next Step:</strong> After generating the token, click "Email Link to Client" to copy an email template. Paste it into your email client and send it to the client approver.</p>';
        html += '<p style="margin: 8px 0 0 0; font-size: 12px; color: #5f6368;">Future approval requests will automatically email this client approver.</p>';
        html += '</div>';
        html += '</div>';

        // Portal URL (if token exists)
        html += '<div id="clientPortalUrl" style="display: none; margin-top: 12px;">';
        html += '<p style="margin-bottom: 8px;"><strong>Client Portal URL:</strong></p>';
        html += '<div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #dadce0; display: flex; gap: 8px; align-items: center;">';
        html += '<input type="text" id="portalUrlInput" readonly style="flex: 1; border: none; font-family: monospace; font-size: 12px; padding: 4px;" value="">';
        html += '<button class="btn btn-secondary" onclick="copyPortalUrl(event)">üìã Copy</button>';
        html += '</div>';
        html += '<div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">';
        html += '<button class="btn btn-secondary" onclick="emailPortalLink()">üìß Email Link to Client</button>';
        html += '<button class="btn btn-warning" onclick="revokeClientToken()" style="background: #ea4335; color: white;">üîí Revoke Access</button>';
        html += '</div>';
        html += '<div style="background: #e8f0fe; padding: 12px; margin-top: 12px; border-radius: 4px; border-left: 3px solid #1a73e8;">';
        html += '<p style="margin: 0; font-size: 12px; color: #5f6368;">‚ÑπÔ∏è This client has portal access. When you submit posts for client review, they will automatically receive email notifications with a link to approve or comment.</p>';
        html += '</div>';
        html += '</div>';

        html += '</div>';
        html += '</div>';

        // Comments section (will be loaded separately)
        html += '<div class="detail-section">';
        html += '<h4>Comments</h4>';
        html += '<div id="commentsContainer" style="margin-bottom: 16px;">';
        html += '<p style="color: #5f6368; font-style: italic;">Loading comments...</p>';
        html += '</div>';

        // Comment form
        html += '<div id="commentForm" style="display: none; background: #f8f9fa; padding: 16px; border-radius: 4px; margin-bottom: 12px;">';
        html += '<div style="margin-bottom: 12px;">';
        html += '<label style="display: block; margin-bottom: 8px; font-weight: 500;">Comment Type:</label>';
        html += '<div style="display: flex; gap: 16px; flex-wrap: wrap;">';
        html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="commentType" value="Internal_Note" checked> Internal Note</label>';
        html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="commentType" value="Revision_Request"> Revision Request</label>';
        html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="commentType" value="Approval_Feedback"> Approval Feedback</label>';
        html += '<label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="radio" name="commentType" value="Question"> Question</label>';
        html += '</div>';
        html += '</div>';
        html += '<div style="margin-bottom: 12px;">';
        html += '<label style="display: block; margin-bottom: 4px; font-weight: 500;">Your Comment:</label>';
        html += '<textarea id="commentTextInput" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; font-family: inherit; resize: vertical;" placeholder="Enter your comment..."></textarea>';
        html += '</div>';
        html += '<div style="display: flex; gap: 8px;">';
        html += '<button class="btn btn-primary" type="button" onclick="submitComment(\'' + post.ID + '\')">Submit Comment</button>';
        html += '<button class="btn btn-secondary" type="button" onclick="cancelComment()">Cancel</button>';
        html += '</div>';
        html += '</div>';

        html += '<button class="btn btn-secondary" id="addCommentBtn" type="button" onclick="showCommentForm()">üí¨ Add Comment</button>';
        html += '</div>';

        html += '</div>';

        // Add CSS for detail sections
        html += `
          <style>
            .post-detail-content {
              padding: 8px 0;
            }
            .detail-section {
              margin-bottom: 20px;
              padding-bottom: 20px;
              border-bottom: 1px solid #e8eaed;
            }
            .detail-section:last-child {
              border-bottom: none;
            }
            .detail-section h4 {
              margin: 0 0 12px 0;
              color: #202124;
              font-size: 14px;
              font-weight: 500;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            .detail-section p {
              margin: 8px 0;
              line-height: 1.6;
            }
          </style>
        `;

        document.getElementById('postDetailBody').innerHTML = html;

        // Update footer with action buttons based on status
        updatePostDetailActions(post);

        // Check client access status if in Client_Review
        checkClientAccess(post);

        // Load comments separately to avoid slowing down initial display
        loadComments(post.ID);
      }

      function loadComments(postId) {
        google.script.run
          .withSuccessHandler(function(comments) {
            displayComments(comments);
          })
          .withFailureHandler(function(error) {
            document.getElementById('commentsContainer').innerHTML =
              '<p style="color: #ea4335;">Error loading comments</p>';
          })
          .getCommentsForPost(postId);
      }

      function displayComments(comments) {
        const container = document.getElementById('commentsContainer');

        if (!comments || comments.length === 0) {
          container.innerHTML = '<p style="color: #5f6368; font-style: italic;">No comments yet</p>';
          return;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
        comments.forEach(comment => {
          // Handle both column name variants (Comment_Date vs Created_Date, Comment_Type vs Commenter_Type)
          const dateValue = comment.Comment_Date || comment.Created_Date;
          const date = dateValue ? new Date(dateValue).toLocaleString() : '';
          const commenter = comment.Commenter_Email || 'Unknown';
          const commentType = comment.Comment_Type || comment.Commenter_Type || 'Internal_Note';

          // Format comment type for display
          const typeLabel = commentType.replace(/_/g, ' ');

          // Color code border by comment type
          let borderColor = '#1a73e8'; // Default blue
          if (commentType === 'Revision_Request') borderColor = '#f9ab00'; // Yellow
          else if (commentType === 'Approval_Feedback') borderColor = '#188038'; // Green
          else if (commentType === 'Question') borderColor = '#ea4335'; // Red

          html += `<div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid ${borderColor};">`;
          html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
          html += `<div style="display: flex; flex-direction: column; gap: 2px;">`;
          html += `<strong style="font-size: 13px;">${escapeHtml(commenter)}</strong>`;
          html += `<span style="font-size: 11px; color: #5f6368; text-transform: capitalize;">${escapeHtml(typeLabel)}</span>`;
          html += `</div>`;
          html += `<span style="font-size: 12px; color: #5f6368;">${date}</span>`;
          html += '</div>';
          html += `<p style="margin: 0; white-space: pre-wrap;">${escapeHtml(comment.Comment_Text)}</p>`;
          html += '</div>';
        });
        html += '</div>';

        container.innerHTML = html;
      }

      function updatePostDetailActions(post) {
        const footer = document.getElementById('postDetailFooter');
        let html = '';

        // Always show Edit Post and Save as Template buttons (on the left)
        html += '<button class="btn btn-primary" type="button" onclick="editCurrentPost()">Edit Post</button>';
        html += ' <button class="btn btn-secondary" type="button" onclick="saveAsTemplate(\'' + post.ID + '\')">üìã Save as Template</button>';

        // Only show Delete button for admins
        if (userRole === 'Admin') {
          html += ' <button class="btn btn-secondary" type="button" onclick="confirmDeletePost(\'' + post.ID + '\', \'' + escapeHtml(post.Post_Title || 'this post').replace(/'/g, "\\'") + '\')" style="color: #ea4335;">üóëÔ∏è Delete Post</button>';
        }

        // Add status change buttons based on current status (in the middle)
        if (post.Status === 'Draft') {
          html += ' <button class="btn btn-primary" type="button" onclick="submitPostForInternalReview(\'' + post.ID + '\')">Submit for Internal Review</button>';
          html += ' <button class="btn btn-primary" type="button" onclick="submitPostForClientReview(\'' + post.ID + '\', true)">üì§ Submit for Client Review (Skip Internal)</button>';
        } else if (post.Status === 'Internal_Review') {
          html += ' <button class="btn btn-primary" type="button" onclick="submitPostForClientReview(\'' + post.ID + '\', false)">üì§ Submit for Client Review</button>';
          html += ' <button class="btn btn-primary" type="button" onclick="submitPostForClientReview(\'' + post.ID + '\', true)">üì§ Skip to Client Review</button>';
          html += ' <button class="btn btn-success" type="button" onclick="changePostStatus(\'' + post.ID + '\', \'Approved\')">Approve</button>';
          html += ' <button class="btn btn-warning" type="button" onclick="changePostStatus(\'' + post.ID + '\', \'Draft\')">Request Changes</button>';
        } else if (post.Status === 'Client_Review') {
          // Allow submitting for client review again (in case need to add more reviewers)
          html += ' <button class="btn btn-primary" type="button" onclick="submitPostForClientReview(\'' + post.ID + '\', false)">üì§ Re-submit for Client Review</button>';
          html += ' <button class="btn btn-success" type="button" onclick="changePostStatus(\'' + post.ID + '\', \'Approved\')">Approve</button>';
          html += ' <button class="btn btn-warning" type="button" onclick="changePostStatus(\'' + post.ID + '\', \'Draft\')">Request Changes</button>';
        } else if (post.Status === 'Approved') {
          html += ' <button class="btn btn-primary" type="button" onclick="changePostStatus(\'' + post.ID + '\', \'Scheduled\')">üìÖ Schedule</button>';
        } else if (post.Status === 'Scheduled') {
          html += ' <button class="btn btn-success" type="button" onclick="markAsPublished(\'' + post.ID + '\')" style="background: #9334e9; border-color: #9334e9;">‚úÖ Mark as Published</button>';
        }

        // Close button always on the right
        html += ' <button class="btn btn-secondary" type="button" onclick="closePostDetail()">Close</button>';

        footer.innerHTML = html;
      }

      function changePostStatus(postId, newStatus) {
        if (!confirm('Change post status to ' + newStatus.replace('_', ' ') + '?')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Refresh the post detail view
              openPostDetail(postId);
              // Invalidate cache and refresh the calendar
              invalidateCalendarCache();
              loadCalendarData();
            } else {
              alert('Error: ' + (result.error || 'Failed to update status'));
            }
          })
          .withFailureHandler(function(error) {
            alert('Error: ' + error.message);
          })
          .updatePostStatus(postId, newStatus);
      }

      function markAsPublished(postId) {
        if (!confirm('Mark this post as Published? This will record today\'s date as the published date.')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              const publishedDate = new Date(result.publishedDate).toLocaleString();
              alert('‚úÖ Post marked as Published!\nüìÖ Published Date: ' + publishedDate);
              // Refresh the post detail view
              openPostDetail(postId);
              // Invalidate cache and refresh the calendar
              invalidateCalendarCache();
              loadCalendarData();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to mark as published'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .markPostAsPublished(postId);
      }

      function editPost(postId) {
        console.log('Editing post:', postId);

        // Close the detail modal
        closePostDetail();

        // Show loading indicator immediately
        const modal = document.getElementById('postCreationModal');
        modal.classList.add('active');
        const modalBody = modal.querySelector('.modal-body');
        const originalContent = modalBody.innerHTML;
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 80px 20px;">
            <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 24px; color: #5f6368; font-size: 16px;">Loading post data...</p>
            <p style="margin-top: 8px; color: #80868b; font-size: 14px;">This may take a moment</p>
          </div>
        `;

        // Load the post data
        google.script.run
          .withSuccessHandler(function(result) {
            // Restore modal content
            modalBody.innerHTML = originalContent;

            if (result.success) {
              loadPostIntoForm(result.post);
            } else {
              modal.classList.remove('active');
              alert('Error loading post: ' + (result.error || 'Failed to load post'));
            }
          })
          .withFailureHandler(function(error) {
            modal.classList.remove('active');
            alert('Error: ' + error.message);
          })
          .getPostById(postId);
      }

      function loadPostIntoForm(post) {
        console.log('Loading post into form:', post);

        // Store the post ID for updating
        window.editingPostId = post.ID;

        // Store the post data globally for reference
        window.currentEditingPost = post;

        // Open the post creation modal
        document.getElementById('postCreationModal').classList.add('active');

        // Update modal title to indicate edit mode
        document.querySelector('#postCreationModal .modal-header h2').textContent = 'Edit Post: ' + post.Post_Title;

        // Add edit mode indicator
        const modalHeader = document.querySelector('#postCreationModal .modal-header');
        let editBadge = document.getElementById('editModeBadge');
        if (!editBadge) {
          editBadge = document.createElement('span');
          editBadge.id = 'editModeBadge';
          editBadge.style.cssText = 'background: #f9ab00; color: #202124; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-left: 12px;';
          editBadge.textContent = 'EDITING';
          modalHeader.querySelector('h2').appendChild(editBadge);
        }

        // Load form options first, then populate fields
        if (!formOptions) {
          google.script.run
            .withSuccessHandler(function(options) {
              if (options.success === false) {
                alert('Failed to load form options: ' + options.error);
                return;
              }
              formOptions = options;

              // Wait for modal to be fully rendered before populating
              setTimeout(function() {
                populateFormDropdowns();

                // Now populate the post data after dropdowns are ready
                populatePostFields(post);

                // Double-check critical fields after another delay to ensure they stick
                setTimeout(function() {
                  if (post.Scheduled_Date) {
                    let dateStr = post.Scheduled_Date;
                    if (typeof dateStr === 'string' && dateStr.includes('T')) {
                      dateStr = dateStr.split('T')[0];
                    }
                    const dateInput = document.getElementById('scheduledDate');
                    if (!dateInput.value || dateInput.value === '') {
                      console.warn('Date was cleared, re-setting to:', dateStr);
                      dateInput.value = dateStr;
                    }
                  }

                  if (post.Hashtags) {
                    const hashtagsInput = document.getElementById('postHashtags');
                    if (!hashtagsInput.value || hashtagsInput.value === '') {
                      console.warn('Hashtags were cleared, re-setting to:', post.Hashtags);
                      hashtagsInput.value = post.Hashtags;
                    }
                  }
                }, 200);
              }, 100);
            })
            .withFailureHandler(function(error) {
              alert('Error loading form options: ' + error.message);
            })
            .getFormOptions();
        } else {
          // Form options already loaded, re-populate dropdowns then fields
          // Wait for modal to be fully rendered before populating
          setTimeout(function() {
            populateFormDropdowns();

            // Small delay to ensure DOM is updated before populating fields
            setTimeout(function() {
              populatePostFields(post);

              // Double-check critical fields after another delay to ensure they stick
              setTimeout(function() {
                if (post.Scheduled_Date) {
                  let dateStr = post.Scheduled_Date;
                  if (typeof dateStr === 'string' && dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                  }
                  const dateInput = document.getElementById('scheduledDate');
                  if (!dateInput.value || dateInput.value === '') {
                    console.warn('Date was cleared, re-setting to:', dateStr);
                    dateInput.value = dateStr;
                  }
                }

                if (post.Hashtags) {
                  const hashtagsInput = document.getElementById('postHashtags');
                  if (!hashtagsInput.value || hashtagsInput.value === '') {
                    console.warn('Hashtags were cleared, re-setting to:', post.Hashtags);
                    hashtagsInput.value = post.Hashtags;
                  }
                }
              }, 200);
            }, 100);
          }, 100);
        }
      }

      function populatePostFields(post) {
        try {
          console.log('=== Populating post fields ===');
          console.log('Post data:', post);

        // Pre-fill basic fields
        document.getElementById('postTitle').value = post.Post_Title || '';
        document.getElementById('postCopy').value = post.Post_Copy || '';

        // Fix date handling to avoid timezone issues
        if (post.Scheduled_Date) {
          // If date is ISO string, extract date part
          let dateStr = post.Scheduled_Date;
          if (typeof dateStr === 'string' && dateStr.includes('T')) {
            dateStr = dateStr.split('T')[0];
          } else if (dateStr instanceof Date || typeof dateStr === 'object') {
            // If it's a Date object from server, convert to local date string
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateStr = year + '-' + month + '-' + day;
          }
          console.log('Setting date to:', dateStr, 'from:', post.Scheduled_Date);
          const dateInput = document.getElementById('scheduledDate');
          if (dateInput) {
            dateInput.value = dateStr;
            // Store in data attribute as backup
            dateInput.setAttribute('data-original-value', dateStr);
          }
        }

        document.getElementById('scheduledTime').value = post.Scheduled_Time || '';
        console.log('Setting status to:', post.Status);
        document.getElementById('postStatus').value = post.Status || 'Draft';
        console.log('Setting hashtags to:', post.Hashtags);
        document.getElementById('postHashtags').value = post.Hashtags || '';
        console.log('Setting link URL to:', post.Link_URL);
        document.getElementById('linkUrl').value = post.Link_URL || '';
        console.log('Setting notes to:', post.Notes);
        document.getElementById('postNotes').value = post.Notes || '';

        // Update character count
        updateCharCount();

        // Select client
        const clientSelect = document.getElementById('postClient');
        console.log('Client dropdown element:', clientSelect);
        console.log('Client dropdown options:', Array.from(clientSelect.options).map(o => o.value));
        console.log('Setting client to:', post.Client_ID);
        clientSelect.value = post.Client_ID || '';
        console.log('Client dropdown value after setting:', clientSelect.value);

        // Load subsidiaries for the client
        if (post.Client_ID) {
          google.script.run
            .withSuccessHandler(function(subsidiaries) {
              populateSubsidiaries(subsidiaries);

              // Select subsidiaries
              if (post.Subsidiary_IDs) {
                const subIds = post.Subsidiary_IDs.split(',').map(id => id.trim());
                subIds.forEach(subId => {
                  const checkbox = document.querySelector('input[name="subsidiaryIds"][value="' + subId + '"]');
                  if (checkbox) checkbox.checked = true;
                });
              }
            })
            .getClientSubsidiaries(post.Client_ID);
        }

        // Select content categories
        console.log('Content_Category:', post.Content_Category);
        console.log('Content_Category_ID:', post.Content_Category_ID);
        if (post.Content_Category || post.Content_Category_ID) {
          const catValues = (post.Content_Category_ID || post.Content_Category).split(',').map(v => v.trim());
          console.log('Category values to select:', catValues);
          const categorySelect = document.getElementById('contentCategory');
          console.log('Category dropdown options:', Array.from(categorySelect.options).map(o => o.value + ':' + o.text));

          // Match by ID first, then try matching by name if needed
          Array.from(categorySelect.options).forEach(option => {
            // Check if matches by ID (e.g., "CAT-003")
            if (catValues.indexOf(option.value) > -1) {
              console.log('Selecting category by ID:', option.value);
              option.selected = true;
            }
            // Check if matches by name (e.g., "Company_Culture" matches "Company Culture")
            else if (catValues.some(val => val.replace(/_/g, ' ').toLowerCase() === option.textContent.trim().toLowerCase())) {
              console.log('Selecting category by name:', option.value, option.textContent);
              option.selected = true;
            }
          });
        }

        // Select approvers
        if (post.Internal_Approvers) {
          const approverIds = post.Internal_Approvers.split(',').map(id => id.trim());
          const approverSelect = document.getElementById('internalApprovers');
          Array.from(approverSelect.options).forEach(option => {
            if (approverIds.indexOf(option.value) > -1) {
              option.selected = true;
            }
          });
        }

        // Populate client approvers (checkboxes and custom field)
        if (post.Client_Approvers) {
          console.log('Setting client approvers to:', post.Client_Approvers);
          const approversList = post.Client_Approvers.split(',').map(email => email.trim());

          // Wait for client approver checkboxes to load, then check the matching ones
          setTimeout(function() {
            const clientApproverCheckboxes = document.querySelectorAll('input[name="clientApproverCheckbox"]');
            const matchedEmails = [];

            clientApproverCheckboxes.forEach(checkbox => {
              if (approversList.includes(checkbox.value)) {
                checkbox.checked = true;
                matchedEmails.push(checkbox.value);
              }
            });

            // Put unmatched emails in custom field
            const unmatchedEmails = approversList.filter(email => !matchedEmails.includes(email));
            if (unmatchedEmails.length > 0) {
              document.getElementById('customClientApprovers').value = unmatchedEmails.join(', ');
            }
          }, 500); // Give time for approvers to load
        }

        // Load platforms
        console.log('Post platforms:', post.platforms);
        if (post.platforms && post.platforms.length > 0) {
          selectedPlatforms = [];
          post.platforms.forEach(platform => {
            console.log('Processing platform:', platform);
            const platformId = platform.Platform_ID || platform.Platform;
            const platformName = platform.Platform_Name || platform.Platform;
            console.log('Platform ID:', platformId, 'Platform Name:', platformName);
            selectedPlatforms.push(platformName); // Use name for checkbox matching

            // Add platform media UI
            setTimeout(() => {
              addPlatformMedia(platformName, platform.Media_File_URL || '', platform.Media_Type || 'Image');
            }, 100);
          });

          // Update platform checkboxes (checkboxes use Platform_Name as value)
          selectedPlatforms.forEach(platformName => {
            console.log('Looking for platform checkbox with value:', platformName);
            const checkbox = document.querySelector('input[value="' + platformName + '"]');
            console.log('Found checkbox:', checkbox);
            if (checkbox) {
              checkbox.checked = true;
              console.log('Checked platform:', platformName);
            }
          });
        }
        } catch (error) {
          console.error('Error in populatePostFields:', error);
          console.error('Error stack:', error.stack);
          alert('Error populating form fields: ' + error.message);
        }
      }

      function showCommentForm() {
        document.getElementById('commentForm').style.display = 'block';
        document.getElementById('addCommentBtn').style.display = 'none';
        document.getElementById('commentTextInput').focus();
      }

      function cancelComment() {
        document.getElementById('commentForm').style.display = 'none';
        document.getElementById('addCommentBtn').style.display = 'inline-flex';
        document.getElementById('commentTextInput').value = '';
        // Reset to default radio button
        document.querySelector('input[name="commentType"][value="Internal_Note"]').checked = true;
      }

      function submitComment(postId) {
        const commentText = document.getElementById('commentTextInput').value.trim();
        if (!commentText) {
          alert('Please enter a comment');
          return;
        }

        // Get selected comment type
        const selectedType = document.querySelector('input[name="commentType"]:checked');
        const commentType = selectedType ? selectedType.value : 'Internal_Note';

        // Show loading state
        const container = document.getElementById('commentsContainer');
        const originalHtml = container.innerHTML;
        container.innerHTML = '<p style="color: #5f6368; font-style: italic;">Saving comment...</p>';

        // Hide form
        document.getElementById('commentForm').style.display = 'none';

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Clear the form
              document.getElementById('commentTextInput').value = '';
              document.querySelector('input[name="commentType"][value="Internal_Note"]').checked = true;

              // Show add button again
              document.getElementById('addCommentBtn').style.display = 'inline-flex';

              // Reload comments to show the new one
              loadComments(postId);
            } else {
              container.innerHTML = originalHtml;
              document.getElementById('commentForm').style.display = 'block';
              alert('Error: ' + (result.error || 'Failed to add comment'));
            }
          })
          .withFailureHandler(function(error) {
            container.innerHTML = originalHtml;
            document.getElementById('commentForm').style.display = 'block';
            alert('Error: ' + error.message);
          })
          .addCommentToPost(postId, commentText, commentType);
      }

      // Show approval dashboard
      function showApprovalDashboard() {
        // Open ApprovalDashboard.html in a modal iframe
        const modal = document.createElement('div');
        modal.id = 'approvalDashboardModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';

        const modalContent = document.createElement('div');
        modalContent.style.cssText = 'background: white; width: 90%; max-width: 1200px; height: 90%; border-radius: 8px; position: relative; display: flex; flex-direction: column;';

        const modalHeader = document.createElement('div');
        modalHeader.style.cssText = 'padding: 20px; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center;';
        modalHeader.innerHTML = '<h2 style="margin: 0; color: #1a73e8;">üìã My Pending Approvals</h2><button onclick="closeApprovalDashboard()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #5f6368;">&times;</button>';

        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'width: 100%; height: 100%; border: none; flex: 1;';
        iframe.src = '<?= ScriptApp.getService().getUrl() ?>?page=approvals';

        modalContent.appendChild(modalHeader);
        modalContent.appendChild(iframe);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // Close on background click
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeApprovalDashboard();
          }
        });
      }

      function closeApprovalDashboard() {
        const modal = document.getElementById('approvalDashboardModal');
        if (modal) {
          modal.remove();
          // Invalidate cache and refresh calendar to show any status changes from approvals
          invalidateCalendarCache();
          loadCalendarData();
        }
      }

      // Utility function
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Image preview functions
      let imagePreviewSetup = false; // Prevent duplicate listeners

      function setupImagePreview() {
        if (imagePreviewSetup) return; // Already set up

        const preview = document.getElementById('imagePreview');
        const calendarTable = document.getElementById('calendar-table');

        if (!calendarTable || !preview) {
          console.log('Calendar table or preview not found');
          return;
        }

        console.log('Setting up image preview listeners');

        // Event delegation for mouseenter
        calendarTable.addEventListener('mouseover', function(e) {
          const postItem = e.target.closest('.post-item[data-image-url]');
          if (postItem) {
            const imageUrl = postItem.getAttribute('data-image-url');
            if (imageUrl) {
              console.log('Showing preview for:', imageUrl);

              // Convert Box.com shared links to direct image URLs
              const embedUrl = imageUrl.includes('box.com/s/')
                ? imageUrl.replace('/s/', '/shared/static/')
                : imageUrl;

              const img = preview.querySelector('img');
              img.src = embedUrl;
              img.onerror = function() {
                console.log('Image failed to load:', embedUrl);
                preview.classList.remove('active');
              };
              preview.classList.add('active');

              // Position near the item, but keep within viewport
              const rect = postItem.getBoundingClientRect();
              const previewWidth = 156; // 150px + 6px border/padding
              const previewHeight = 156;

              // Calculate position to the right of the item
              let left = rect.right + 10;
              let top = rect.top;

              // If preview would go off right edge, position to the left instead
              if (left + previewWidth > window.innerWidth) {
                left = rect.left - previewWidth - 10;
              }

              // If preview would go off bottom edge, adjust top position
              if (top + previewHeight > window.innerHeight) {
                top = window.innerHeight - previewHeight - 10;
              }

              // Don't let it go off the top edge
              if (top < 10) {
                top = 10;
              }

              preview.style.left = left + 'px';
              preview.style.top = top + 'px';
            }
          }
        });

        // Event delegation for mouseleave - use relatedTarget to avoid flickering
        calendarTable.addEventListener('mouseout', function(e) {
          // Only hide if we're actually leaving the post item (not just moving to a child)
          const postItem = e.target.closest('.post-item[data-image-url]');
          if (postItem && !postItem.contains(e.relatedTarget)) {
            console.log('Hiding preview');
            preview.classList.remove('active');
          }
        });

        imagePreviewSetup = true;
        console.log('Image preview setup complete');
      }

      // Post Creation Form Functions
      let formOptions = null;
      let selectedPlatforms = [];

      function openPostCreationForm() {
        const modal = document.getElementById('postCreationModal');
        modal.classList.add('active');

        // Load form options if not already loaded
        if (!formOptions) {
          loadFormOptions();
        }

        // Load templates if not already loaded
        if (allTemplates.length === 0) {
          refreshTemplates();
        }

        // Set up character counter
        const copyTextarea = document.getElementById('postCopy');
        copyTextarea.addEventListener('input', updateCharCount);
      }

      function closePostCreationForm() {
        const modal = document.getElementById('postCreationModal');
        modal.classList.remove('active');
        resetForm();

        // Clear edit mode
        window.editingPostId = null;

        // Reset modal title
        document.querySelector('#postCreationModal .modal-header h2').textContent = 'Create New Post';

        // Remove edit badge
        const editBadge = document.getElementById('editModeBadge');
        if (editBadge) {
          editBadge.remove();
        }
      }

      function loadFormOptions() {
        // Show loading skeleton
        showFormLoadingSkeleton();

        google.script.run
          .withSuccessHandler(function(options) {
            if (options.success === false) {
              showFormError('Failed to load form options: ' + options.error);
              return;
            }

            formOptions = options;
            populateFormDropdowns();
            hideFormLoadingSkeleton();
          })
          .withFailureHandler(function(error) {
            showFormError('Error loading form: ' + error.message);
            hideFormLoadingSkeleton();
          })
          .getFormOptions();
      }

      function showFormLoadingSkeleton() {
        // Disable form inputs and show skeleton placeholders
        const clientSelect = document.getElementById('postClient');
        const platformsContainer = document.getElementById('platformsContainer');
        const categorySelect = document.getElementById('contentCategory');

        if (clientSelect) {
          clientSelect.disabled = true;
          clientSelect.style.opacity = '0.5';
        }

        if (platformsContainer) {
          platformsContainer.innerHTML = '<div class="skeleton-form-checkboxes">' +
            '<div class="skeleton skeleton-form-checkbox"></div>' +
            '<div class="skeleton skeleton-form-checkbox"></div>' +
            '<div class="skeleton skeleton-form-checkbox"></div>' +
            '<div class="skeleton skeleton-form-checkbox"></div>' +
            '<div class="skeleton skeleton-form-checkbox"></div>' +
            '</div>';
        }

        if (categorySelect) {
          categorySelect.disabled = true;
          categorySelect.style.opacity = '0.5';
        }
      }

      function hideFormLoadingSkeleton() {
        // Re-enable form inputs
        const clientSelect = document.getElementById('postClient');
        const categorySelect = document.getElementById('contentCategory');

        if (clientSelect) {
          clientSelect.disabled = false;
          clientSelect.style.opacity = '1';
        }

        if (categorySelect) {
          categorySelect.disabled = false;
          categorySelect.style.opacity = '1';
        }
      }

      function populateFormDropdowns() {
        // Populate clients
        const clientSelect = document.getElementById('postClient');
        if (!clientSelect) {
          console.error('Client select element not found - modal may not be ready yet');
          return;
        }
        clientSelect.innerHTML = '<option value="">Select a client...</option>';
        formOptions.clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.ID;
          option.textContent = client.Client_Name;
          clientSelect.appendChild(option);
        });

        // Populate platforms
        const platformsContainer = document.getElementById('platformsContainer');
        platformsContainer.innerHTML = '';
        formOptions.platforms.forEach(platform => {
          const label = document.createElement('label');
          label.className = 'checkbox-item';
          label.innerHTML =
            '<input type="checkbox" value="' + platform.Platform_Name + '" onchange="togglePlatformMedia(\'' + platform.Platform_Name + '\')">' +
            '<span>' + platform.Platform_Name + '</span>';
          platformsContainer.appendChild(label);
        });

        // Populate categories
        const categorySelect = document.getElementById('contentCategory');
        categorySelect.innerHTML = '';
        formOptions.categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.ID;
          option.textContent = category.Category_Name;
          categorySelect.appendChild(option);
        });

        // Populate internal approvers
        const approversSelect = document.getElementById('internalApprovers');
        approversSelect.innerHTML = '';
        formOptions.users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.Email;
          option.textContent = user.Full_Name + ' (' + user.Email + ')';
          approversSelect.appendChild(option);
        });
      }

      function populateSubsidiaries(subsidiaries) {
        const subsidiariesContainer = document.getElementById('subsidiariesContainer');

        if (!subsidiaries || subsidiaries.length === 0) {
          subsidiariesContainer.innerHTML = '<span class="form-help">No subsidiaries for this client</span>';
          return;
        }

        subsidiariesContainer.innerHTML = '';
        subsidiaries.forEach(sub => {
          const label = document.createElement('label');
          label.className = 'checkbox-item';
          label.innerHTML =
            '<input type="checkbox" name="subsidiaryIds" value="' + sub.ID + '">' +
            '<span>' + sub.Subsidiary_Name + '</span>';
          subsidiariesContainer.appendChild(label);
        });
      }

      function loadSubsidiaries() {
        const clientId = document.getElementById('postClient').value;
        const subsidiariesContainer = document.getElementById('subsidiariesContainer');
        const clientApproversContainer = document.getElementById('clientApproversContainer');

        if (!clientId) {
          subsidiariesContainer.innerHTML = '<span class="form-help">Select a client first</span>';
          clientApproversContainer.innerHTML = '<span class="form-help">Select a client first</span>';
          return;
        }

        // Load subsidiaries
        google.script.run
          .withSuccessHandler(populateSubsidiaries)
          .withFailureHandler(function(error) {
            subsidiariesContainer.innerHTML = '<span class="form-help" style="color: #ea4335;">Error loading subsidiaries</span>';
          })
          .getClientSubsidiaries(clientId);

        // Load client approvers
        google.script.run
          .withSuccessHandler(populateClientApprovers)
          .withFailureHandler(function(error) {
            clientApproversContainer.innerHTML = '<span class="form-help" style="color: #ea4335;">Error loading approvers</span>';
          })
          .getClientApprovers(clientId);
      }

      function populateClientApprovers(approverEmails) {
        const clientApproversContainer = document.getElementById('clientApproversContainer');

        if (!approverEmails || approverEmails.length === 0) {
          clientApproversContainer.innerHTML = '<span class="form-help">No authorized contacts for this client yet. Add custom emails below.</span>';
          return;
        }

        clientApproversContainer.innerHTML = '';
        approverEmails.forEach(email => {
          const label = document.createElement('label');
          label.className = 'checkbox-item';
          label.innerHTML =
            '<input type="checkbox" name="clientApproverCheckbox" value="' + email + '">' +
            '<span>' + email + '</span>';
          clientApproversContainer.appendChild(label);
        });
      }

      function addPlatformMedia(platformName, mediaUrl, mediaType) {
        const platformMediaContainer = document.getElementById('platformMediaContainer');

        // Check if media area already exists
        let mediaArea = document.getElementById('platform-media-' + platformName);
        if (!mediaArea) {
          // Create new media upload area
          mediaArea = document.createElement('div');
          mediaArea.id = 'platform-media-' + platformName;
          mediaArea.className = 'platform-media active';
          mediaArea.innerHTML =
            '<div class="platform-media-title">' + platformName + ' Media</div>' +
            '<div class="form-row">' +
              '<div class="form-group">' +
                '<label for="media-url-' + platformName + '">Media URL (Box.com link)</label>' +
                '<input type="url" id="media-url-' + platformName + '" placeholder="https://box.com/...">' +
              '</div>' +
              '<div class="form-group">' +
                '<label for="media-type-' + platformName + '">Media Type</label>' +
                '<select id="media-type-' + platformName + '">' +
                  '<option value="Image">Image</option>' +
                  '<option value="Video">Video</option>' +
                  '<option value="Carousel">Carousel</option>' +
                '</select>' +
              '</div>' +
            '</div>';
          platformMediaContainer.appendChild(mediaArea);
        }

        // Populate with existing values if provided
        if (mediaUrl) {
          const urlInput = document.getElementById('media-url-' + platformName);
          if (urlInput) urlInput.value = mediaUrl;
        }
        if (mediaType) {
          const typeSelect = document.getElementById('media-type-' + platformName);
          if (typeSelect) typeSelect.value = mediaType;
        }
      }

      function togglePlatformMedia(platformName) {
        // Find the checkbox that triggered this event
        const checkbox = document.querySelector('input[type="checkbox"][value="' + platformName + '"]');
        const platformMediaContainer = document.getElementById('platformMediaContainer');

        if (checkbox.checked) {
          // Add platform to selected list
          if (!selectedPlatforms.includes(platformName)) {
            selectedPlatforms.push(platformName);
          }

          // Create media upload area for this platform
          const mediaArea = document.createElement('div');
          mediaArea.id = 'platform-media-' + platformName;
          mediaArea.className = 'platform-media active';
          mediaArea.innerHTML =
            '<div class="platform-media-title">' + platformName + ' Media</div>' +
            '<div class="form-row">' +
              '<div class="form-group">' +
                '<label for="media-url-' + platformName + '">Media URL (Box.com link)</label>' +
                '<input type="url" id="media-url-' + platformName + '" placeholder="https://box.com/...">' +
              '</div>' +
              '<div class="form-group">' +
                '<label for="media-type-' + platformName + '">Media Type</label>' +
                '<select id="media-type-' + platformName + '">' +
                  '<option value="Image">Image</option>' +
                  '<option value="Video">Video</option>' +
                  '<option value="Carousel">Carousel</option>' +
                '</select>' +
              '</div>' +
            '</div>';
          platformMediaContainer.appendChild(mediaArea);
        } else {
          // Remove platform from selected list
          selectedPlatforms = selectedPlatforms.filter(p => p !== platformName);

          // Remove media upload area
          const mediaArea = document.getElementById('platform-media-' + platformName);
          if (mediaArea) {
            mediaArea.remove();
          }
        }
      }

      function updateCharCount() {
        const copyTextarea = document.getElementById('postCopy');
        const charCount = document.getElementById('copyCharCount');
        charCount.textContent = copyTextarea.value.length;
      }

      function validateForm() {
        const errors = [];

        // Required fields
        if (!document.getElementById('postClient').value) {
          errors.push('Client is required');
        }
        if (!document.getElementById('postTitle').value.trim()) {
          errors.push('Post title is required');
        }
        if (!document.getElementById('postCopy').value.trim()) {
          errors.push('Post copy is required');
        }
        // Hashtags are now optional - removed validation
        if (!document.getElementById('scheduledDate').value) {
          errors.push('Scheduled date is required');
        }

        // At least one platform must be selected
        const platformCheckboxes = document.querySelectorAll('#platformsContainer input[type="checkbox"]:checked');
        if (platformCheckboxes.length === 0) {
          errors.push('At least one platform must be selected');
        }

        // At least one internal approver must be selected
        const approverSelect = document.getElementById('internalApprovers');
        if (approverSelect.selectedOptions.length === 0) {
          errors.push('At least one internal approver must be selected');
        }

        return errors;
      }

      function collectFormData(submitForReview) {
        // Collect basic data
        const formData = {
          clientId: document.getElementById('postClient').value,
          title: document.getElementById('postTitle').value.trim(),
          copy: document.getElementById('postCopy').value.trim(),
          hashtags: document.getElementById('postHashtags').value.trim(),
          scheduledDate: document.getElementById('scheduledDate').value,
          scheduledTime: document.getElementById('scheduledTime').value,
          status: document.getElementById('postStatus').value,
          categoryId: Array.from(document.getElementById('contentCategory').selectedOptions).map(opt => opt.value).join(', '),
          linkUrl: document.getElementById('linkUrl').value.trim(),
          notes: document.getElementById('postNotes').value.trim(),
          submitForReview: submitForReview
        };

        // Collect subsidiaries
        const subsidiaryCheckboxes = document.querySelectorAll('input[name="subsidiaryIds"]:checked');
        formData.subsidiaryIds = Array.from(subsidiaryCheckboxes).map(cb => cb.value).join(', ');

        // Collect internal approvers
        const approverSelect = document.getElementById('internalApprovers');
        formData.internalApprovers = Array.from(approverSelect.selectedOptions).map(opt => opt.value).join(', ');

        // Collect client approvers from checkboxes
        const clientApproverCheckboxes = document.querySelectorAll('input[name="clientApproverCheckbox"]:checked');
        const checkedApprovers = Array.from(clientApproverCheckboxes).map(cb => cb.value);

        // Collect custom client approvers from textarea
        const customApprovers = document.getElementById('customClientApprovers').value.trim();
        const customApproversList = customApprovers ? customApprovers.split(',').map(email => email.trim()).filter(email => email) : [];

        // Combine and deduplicate
        const allClientApprovers = [...new Set([...checkedApprovers, ...customApproversList])];
        formData.clientApprovers = allClientApprovers.join(', ');

        // Collect platform data
        formData.platforms = selectedPlatforms.map(platformName => {
          return {
            platformName: platformName,
            mediaUrl: document.getElementById('media-url-' + platformName)?.value || '',
            mediaType: document.getElementById('media-type-' + platformName)?.value || 'Image'
          };
        });

        return formData;
      }

      function savePostAsDraft() {
        const errors = validateForm();
        if (errors.length > 0) {
          showFormError(errors.join('<br>'));
          return;
        }

        const formData = collectFormData(false);
        // Force status to Draft when clicking "Save as Draft"
        formData.status = 'Draft';
        submitPost(formData);
      }

      function submitPostForReview() {
        const errors = validateForm();
        if (errors.length > 0) {
          showFormError(errors.join('<br>'));
          return;
        }

        const formData = collectFormData(true);
        submitPost(formData);
      }

      function submitPost(formData) {
        // Find the submit button based on what was clicked
        // Try both buttons (save draft or submit for review)
        const submitBtn = document.getElementById('submitReviewBtn') || document.getElementById('saveDraftBtn');
        const originalText = submitBtn ? submitBtn.textContent : '';

        if (submitBtn) {
          submitBtn.textContent = 'Saving...';
          submitBtn.disabled = true;
        }

        hideFormMessages();

        // Check if we're in edit mode
        const isEditing = window.editingPostId ? true : false;
        const postId = window.editingPostId;

        const successHandler = function(result) {
          if (submitBtn) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }

          if (result.success) {
            showFormSuccess(result.message);
            console.log(isEditing ? 'Post updated successfully' : 'Post created successfully', ', refreshing calendar...');

            // Close form and reload calendar
            setTimeout(() => {
              closePostCreationForm();

              // Force a full calendar reload (invalidate cache first)
              console.log('Calling loadCalendarData()...');
              invalidateCalendarCache();
              loadCalendarData();
            }, 1500);
          } else {
            showFormError(result.error || (isEditing ? 'Failed to update post' : 'Failed to create post'));
          }
        };

        const failureHandler = function(error) {
          if (submitBtn) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
          showFormError('Error: ' + error.message);
        };

        if (isEditing) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .updatePostFromUI(postId, formData);
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .createPostFromUI(formData);
        }
      }

      function resetForm() {
        document.getElementById('postCreationForm').reset();
        document.getElementById('subsidiariesContainer').innerHTML = '<span class="form-help">Select a client first</span>';
        document.getElementById('clientApproversContainer').innerHTML = '<span class="form-help">Select a client first</span>';
        document.getElementById('platformMediaContainer').innerHTML = '';
        selectedPlatforms = [];
        document.getElementById('copyCharCount').textContent = '0';

        // Reset template selector
        const templateSelector = document.getElementById('templateSelector');
        if (templateSelector) {
          templateSelector.value = '';
        }

        // Reset custom client approvers
        const customApprovers = document.getElementById('customClientApprovers');
        if (customApprovers) {
          customApprovers.value = '';
        }

        hideFormMessages();
      }

      function showFormError(message) {
        const errorDiv = document.getElementById('formError');
        errorDiv.innerHTML = message;
        errorDiv.classList.add('active');
        // Scroll to top of modal to show error
        document.querySelector('.modal-body').scrollTop = 0;
      }

      function showFormSuccess(message) {
        const successDiv = document.getElementById('formSuccess');
        successDiv.innerHTML = message;
        successDiv.classList.add('active');
        // Scroll to top of modal to show success
        document.querySelector('.modal-body').scrollTop = 0;
      }

      function hideFormMessages() {
        document.getElementById('formError').classList.remove('active');
        document.getElementById('formSuccess').classList.remove('active');
      }

      // =====================================================
      // CLIENT PORTAL ACCESS MANAGEMENT
      // =====================================================

      function checkClientAccess(post) {
        if (post.Status !== 'Client_Review') {
          document.getElementById('clientAccessSection').style.display = 'none';
          return;
        }

        document.getElementById('clientAccessSection').style.display = 'block';

        // Check if client already has access
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.hasAccess) {
              // Show portal URL
              document.getElementById('clientTokenGenerator').style.display = 'none';
              document.getElementById('clientPortalUrl').style.display = 'block';

              // Use stored Access_URL from database (or fallback to constructing it)
              const portalUrl = result.accessUrl || ('https://script.google.com/macros/s/AKfycbwiRbuwQTrj--xfmP7klfZ_TJratdAySuujz3oSZ3-31SgTY0KA5Zsz75BDLBU-sCCV/exec?page=client&token=' + result.token);
              document.getElementById('portalUrlInput').value = portalUrl;

              // Extract first email for display
              const firstEmail = post.Client_Approvers ? post.Client_Approvers.split(',')[0].trim() : 'unknown';

              document.getElementById('clientTokenStatus').innerHTML =
                '<p style="color: #34a853;">‚úÖ ' + firstEmail + ' has portal access</p>' +
                '<p style="font-size: 13px; color: #5f6368;">Last login: ' + (result.lastLogin || 'Never') + '</p>';
            } else {
              // Show token generator
              document.getElementById('clientTokenGenerator').style.display = 'block';
              document.getElementById('clientPortalUrl').style.display = 'none';

              // Extract first email for display
              const firstEmail = post.Client_Approvers ? post.Client_Approvers.split(',')[0].trim() : 'unknown';

              document.getElementById('clientTokenStatus').innerHTML = `
                <p style="color: #f9ab00;">‚ö†Ô∏è ${firstEmail} doesn't have portal access yet</p>
                <p style="font-size: 13px; color: #5f6368;">Token will be generated for the first client approver email.</p>
              `;
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('clientTokenStatus').innerHTML =
              '<p style="color: #ea4335;">‚ùå Error checking access: ' + error.message + '</p>';
          })
          .checkClientHasAccess(post.Client_ID, post.Client_Approvers);
      }

      function generateClientToken() {
        console.log('=== generateClientToken called ===');
        const post = window.currentPostData;
        console.log('Post data:', post);

        if (!post) {
          alert('Error: Post data not found');
          return;
        }

        if (!post.Client_Approvers || post.Client_Approvers.trim() === '') {
          alert('‚ùå Error: No client approver email found. Please add a client approver to this post first.');
          return;
        }

        console.log('About to show confirmation dialog...');
        if (!confirm('Generate portal access for this client?')) {
          console.log('User cancelled token generation');
          return;
        }

        console.log('Calling grantClientAccessForPost with:', {
          postId: post.ID,
          clientId: post.Client_ID,
          approvers: post.Client_Approvers
        });

        google.script.run
          .withSuccessHandler(function(result) {
            console.log('Success handler called:', result);
            if (result.success) {
              alert('‚úÖ Client access granted!\n\nAccess URL has been generated. Use the "Copy" button below to share it with the client.');
              // Refresh to show URL
              checkClientAccess(post);
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to generate token'));
            }
          })
          .withFailureHandler(function(error) {
            console.error('Failure handler called:', error);
            alert('‚ùå Error: ' + error.message);
          })
          .grantClientAccessForPost(post.ID, post.Client_ID, post.Client_Approvers);

        console.log('google.script.run call initiated');
      }

      function copyPortalUrl(event) {
        const input = document.getElementById('portalUrlInput');
        input.select();
        input.setSelectionRange(0, 99999); // For mobile devices

        try {
          document.execCommand('copy');

          // Show feedback
          const button = event.target;
          const originalText = button.textContent;
          const originalBg = button.style.background;

          button.textContent = '‚úÖ Copied!';
          button.style.background = '#34a853';

          setTimeout(function() {
            button.textContent = originalText;
            button.style.background = originalBg;
          }, 2000);
        } catch (err) {
          alert('Failed to copy. Please copy manually: ' + input.value);
        }
      }

      function emailPortalLink() {
        const post = window.currentPostData;
        const portalUrl = document.getElementById('portalUrlInput').value;

        if (!post) {
          alert('Error: Post data not found');
          return;
        }

        const emailTemplate = 'Subject: Review Your Social Media Posts\n\n' +
          'Hi,\n\n' +
          'You can now review and approve your upcoming social media posts online!\n\n' +
          'Access your content calendar here:\n' +
          portalUrl + '\n\n' +
          'Features:\n' +
          '‚úÖ View all scheduled posts\n' +
          '‚úÖ Approve or request changes\n' +
          '‚úÖ Add comments and feedback\n' +
          '‚úÖ No login required - just bookmark this link\n\n' +
          'Please keep this link private as it\'s unique to your account.\n\n' +
          'Questions? Just reply to this email.\n\n' +
          'Best regards,\n' +
          userName;

        if (confirm('Copy email template to clipboard?')) {
          const tempArea = document.createElement('textarea');
          tempArea.value = emailTemplate;
          tempArea.style.position = 'fixed';
          tempArea.style.left = '-9999px';
          document.body.appendChild(tempArea);
          tempArea.select();

          try {
            document.execCommand('copy');
            document.body.removeChild(tempArea);
            alert('‚úÖ Email template copied to clipboard!\n\nPaste into your email client and send to:\n' + post.Client_Approvers);
          } catch (err) {
            document.body.removeChild(tempArea);
            alert('Failed to copy. Please copy manually.');
          }
        }
      }

      function revokeClientToken() {
        const post = window.currentPostData;

        if (!post) {
          alert('Error: Post data not found');
          return;
        }

        if (!confirm('‚ö†Ô∏è Revoke client portal access?\n\nThe client will no longer be able to view or approve posts.')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ Client access revoked');
              checkClientAccess(post);
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to revoke access'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .revokeClientAccessForClient(post.Client_ID);
      }

      function submitPostForInternalReview(postId) {
        if (!confirm('Submit this post for internal review?\n\nApproval records will be created and the post status will change to Internal Review.')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              const emailMsg = result.approverCount > 0
                ? '\n\nüìß Email notifications sent to ' + result.approverCount + ' internal approver(s)'
                : '\n\n‚ö†Ô∏è No email sent (no approvers configured)';
              alert('‚úÖ Post submitted for internal review!' + emailMsg);
              // Refresh post detail
              openPostDetail(postId);
              // Invalidate cache and refresh calendar
              invalidateCalendarCache();
              loadCalendarData();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to submit for review'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .submitForInternalReview(postId);
      }

      function submitPostForClientReview(postId, skipInternal) {
        const skipMsg = skipInternal ? ' (skipping internal review)' : '';
        if (!confirm('Submit this post for client review' + skipMsg + '?\n\nAn approval record will be created and the post status will change to Client Review.')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              const emailMsg = result.approverCount > 0
                ? '\n\nüìß Email notifications sent to ' + result.approverCount + ' approver(s)'
                : '\n\n‚ö†Ô∏è No email sent (no approvers configured)';
              alert('‚úÖ Post submitted for client review!' + emailMsg);
              // Refresh post detail
              openPostDetail(postId);
              // Invalidate cache and refresh calendar
              invalidateCalendarCache();
              loadCalendarData();
            } else {
              alert('‚ùå Error: ' + (result.error || 'Failed to submit for review'));
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå Error: ' + error.message);
          })
          .submitForClientReview(postId, skipInternal);
      }

    // =====================================================
    // NOTIFICATION SYSTEM
    // =====================================================

    /**
     * Toggle notification dropdown visibility
     */
    function toggleNotifications() {
      const dropdown = document.getElementById('notificationDropdown');
      const isVisible = dropdown.style.display === 'block';

      if (isVisible) {
        dropdown.style.display = 'none';
      } else {
        dropdown.style.display = 'block';
        loadNotifications();
      }
    }

    /**
     * Load unread notifications from server
     */
    function loadNotifications() {
      document.getElementById('notificationList').innerHTML =
        '<div style="padding: 20px; text-align: center; color: #5f6368;">Loading...</div>';

      google.script.run
        .withSuccessHandler(displayNotifications)
        .withFailureHandler(function(error) {
          console.error('Error loading notifications:', error);
          document.getElementById('notificationList').innerHTML =
            '<div style="padding: 20px; text-align: center; color: #ea4335;">Error loading notifications</div>';
        })
        .getUnreadNotifications('<?= userEmail ?>');
    }

    /**
     * Generate a test notification
     * Simulates receiving a notification from another user
     */
    function generateTestNotification() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('‚úÖ Test notification created!\n\n' +
                  'From: ' + result.details.from + '\n' +
                  'Type: ' + result.details.type + '\n' +
                  'Post: ' + result.details.post + '\n\n' +
                  'Check your notification bell (üîî) to see it!');
            // Reload notifications to show the new test notification
            loadNotifications();
          } else {
            alert('‚ùå Error: ' + (result.error || 'Failed to create test notification'));
          }
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Error: ' + error.message);
        })
        .createTestNotification();
    }

    /**
     * Display notifications in dropdown
     */
    function displayNotifications(notifications) {
      const listContainer = document.getElementById('notificationList');

      if (!notifications || notifications.length === 0) {
        listContainer.innerHTML =
          '<div style="padding: 20px; text-align: center; color: #5f6368;">No new notifications</div>';
        updateNotificationBadge(0);
        return;
      }

      let html = '';
      notifications.forEach(function(notification) {
        const timeAgo = getTimeAgo(notification.Created_Date);
        const icon = getNotificationIcon(notification.Type);

        html += '<div class="notification-item" onclick="handleNotificationClick(\'' + notification.ID + '\', \'' + (notification.Post_ID || '') + '\')" style="padding: 12px; border-bottom: 1px solid #f1f3f4; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">';
        html += '  <div style="display: flex; align-items: start; gap: 8px;">';
        html += '    <span style="font-size: 16px;">' + icon + '</span>';
        html += '    <div style="flex: 1;">';
        html += '      <div style="font-size: 13px; color: #202124; margin-bottom: 4px;">' + escapeHtml(notification.Message) + '</div>';
        html += '      <div style="font-size: 11px; color: #5f6368;">' + timeAgo + '</div>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      });

      listContainer.innerHTML = html;
      updateNotificationBadge(notifications.length);
    }

    /**
     * Handle notification click
     */
    function handleNotificationClick(notificationId, postId) {
      // Mark as read
      google.script.run
        .withSuccessHandler(function() {
          // Navigate to post if postId exists
          if (postId) {
            toggleNotifications(); // Close dropdown
            openPostDetail(postId);
          }
          // Refresh notification list
          loadNotifications();
        })
        .withFailureHandler(function(error) {
          console.error('Error marking notification read:', error);
        })
        .markNotificationRead(notificationId);
    }

    /**
     * Mark all notifications as read
     */
    function markAllNotificationsRead() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadNotifications(); // Refresh list
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error marking all notifications read:', error);
        })
        .markAllNotificationsRead('<?= userEmail ?>');
    }

    /**
     * Update notification badge count
     */
    function updateNotificationBadge(count) {
      const badge = document.getElementById('notification-count');
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline-block' : 'none';
    }

    /**
     * Get icon for notification type
     */
    function getNotificationIcon(type) {
      const icons = {
        'approval_request': 'üìã',
        'approval_decision': '‚úÖ',
        'comment_added': 'üí¨',
        'status_change': 'üîÑ',
        'mention': '@'
      };
      return icons[type] || 'üîî';
    }

    /**
     * Get human-readable time ago string
     */
    function getTimeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);

      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
      return date.toLocaleDateString();
    }

    /**
     * Auto-refresh notification count every 60 seconds
     */
    setInterval(function() {
      google.script.run
        .withSuccessHandler(function(count) {
          updateNotificationBadge(count);
        })
        .withFailureHandler(function(error) {
          console.error('Error getting notification count:', error);
        })
        .getUnreadNotificationCount('<?= userEmail ?>');
    }, 60000);

    /**
     * Load initial notification count on page load
     */
    window.addEventListener('DOMContentLoaded', function() {
      google.script.run
        .withSuccessHandler(function(count) {
          updateNotificationBadge(count);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading initial notification count:', error);
        })
        .getUnreadNotificationCount('<?= userEmail ?>');
    });

    /**
     * Close notification dropdown when clicking outside
     */
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('notificationDropdown');
      const bell = document.getElementById('notificationBell');

      if (dropdown && bell && dropdown.style.display === 'block') {
        if (!bell.contains(event.target) && !dropdown.contains(event.target)) {
          dropdown.style.display = 'none';
        }
      }
    });

    </script>
  </body>
</html>